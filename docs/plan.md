# 簡単日報くん 要件定義書・仕様書（WEBアプリ版）

## 0. ドキュメント情報

| 項目 | 内容 |
|------|------|
| 文書名 | 簡単日報くん 要件定義書・仕様書（WEBアプリ版） |
| バージョン | 2.2 |
| 作成日 | 2026-01-11 |
| 最終更新日 | 2026-02-08 |
| 作成者 | - |
| 承認者 | - |
| 改定履歴 | v1.0: 初版作成（スプレッドシート版）<br>v1.1: システム名を「簡単日報くん」に変更（2026-01-11）<br>v1.2: セクション番号の不整合を修正（2026-01-11）<br>v2.0: WEBアプリ版に全面書き換え（2026-01-11）<br>v2.1: V2仕様（テンプレート変更＋翌日引き継ぎ）をSSOTとして統合（2026-02-08）<br>v2.2: V3仕様（ツール連携Slack/Gmail/Notion＋日付指定UI）を27章として統合（2026-02-08） |

## 1. 目的・背景

### 1.1 目的

Googleカレンダーから今日の予定を取得し、
WEBブラウザ上で表示・編集・コピー → Slack送信できる「簡単日報くん」WEBアプリを作る。

### 1.2 背景・課題

- 日報作成に時間がかかる
- カレンダーの情報を手動で転記する必要がある
- 日報のフォーマット統一が困難
- 日報の送信漏れが発生する可能性がある
- スプレッドシートを使わず、より簡単に日報を作成したい

### 1.3 期待される効果

- 日報作成時間の短縮
- 情報の転記ミス削減
- 日報フォーマットの統一
- 送信漏れの防止
- ブラウザから簡単にアクセスできる
- スプレッドシートの準備が不要

## 2. 対象ツール・環境

### 2.1 使用ツール

- Google Apps Script（GAS）（バックエンドスクリプト）
- GAS HTMLサービス（フロントエンドUI）
- Google Calendar API（予定取得）
- Slack Incoming Webhook（日報送信）

### 2.2 前提条件・制約事項

#### 2.2.1 環境要件

- Googleアカウントが必要（Gmailアカウント、Google Workspaceアカウントのいずれか）
- Googleカレンダーへのアクセス権限が必要
- Slackワークスペースへのアクセス権限が必要
- Slack Incoming Webhookの作成権限が必要
- モダンブラウザ（Chrome、Firefox、Safari、Edge等）

#### 2.2.2 技術的制約

- GASの実行時間制限：6分（無料版）
- GASの実行回数制限：1日あたり20,000回（無料版）
- Calendar APIの利用制限：1秒あたり250クエリ
- Slack Webhookの送信制限：1秒あたり1リクエスト（推奨）
- HTMLサービスはサーバーサイドで実行される（クライアント側のJavaScript制限あり）

#### 2.2.3 データ制約

- カレンダー予定データのみを使用（KPIデータは使用しない）
- データはセッション内でのみ保持（ページを閉じると消える）
- 過去のデータは保存されない（毎回カレンダーから取得）

#### 2.2.4 運用制約

- 当日のカレンダー予定のみ取得対象
- ブラウザを閉じると編集内容は失われる
- 送信済みのデータは履歴に残らない

## 3. ユースケース・ユーザーストーリー

### 3.1 ユースケース1：カレンダー予定の取得と表示

**アクター：** ユーザー

**前提条件：**
- GAS WEBアプリのURLにアクセスできる
- Googleアカウントでログインしている
- カレンダーにアクセス権限がある

**基本フロー：**
1. ユーザーがWEBアプリのURLにアクセス
2. ユーザーが「今日の予定を取得」ボタンをクリック
3. システムがGoogleカレンダーから今日の予定を取得
4. システムがWEB画面に予定を表示（タイトル、時間）
5. ユーザーが予定を確認

**例外フロー：**
- 3a. カレンダーアクセス権限なし：エラーメッセージ表示
- 3b. カレンダーに予定が0件：空の状態を表示
- 3c. カレンダー取得エラー：エラーメッセージ表示

### 3.2 ユースケース2：データの編集

**アクター：** ユーザー

**前提条件：**
- カレンダー予定が取得され、画面に表示されている

**基本フロー：**
1. ユーザーが表示された予定データを確認
2. ユーザーがテキストエリアで予定データを編集
3. ユーザーが編集内容を確認
4. 編集内容が画面に反映される

### 3.3 ユースケース3：データのコピー

**アクター：** ユーザー

**前提条件：**
- 予定データが画面に表示されている（編集後でも可）

**基本フロー：**
1. ユーザーが「コピー」ボタンをクリック
2. システムが表示されているテキストをクリップボードにコピー
3. ユーザーが他のアプリケーションに貼り付け可能になる

### 3.4 ユースケース4：Slack送信

**アクター：** ユーザー

**前提条件：**
- 予定データが画面に表示されている（編集後でも可）
- Slack Webhook URLを設定済み

**基本フロー：**
1. ユーザーがSlackチャンネル名を入力（または選択）
2. ユーザーが「Slackに投稿」ボタンをクリック
3. システムがWebhook URLを取得（スクリプトプロパティまたは入力）
4. システムがSlack投稿本文を生成
5. システムがSlack Incoming Webhook APIにPOSTリクエストを送信
6. システムが送信成功メッセージを表示
7. ユーザーがSlackで投稿を確認

**例外フロー：**
- 3a. Webhook URL未設定：エラーメッセージ表示
- 4a. チャンネル名無効：エラーメッセージ表示
- 5a. 送信失敗：エラーメッセージ表示

## 4. 機能要件

### 4.1 カレンダー予定の取得

#### 4.1.1 対象日

- **定義：** スクリプト実行時の日付（システム日時基準）
- **形式：** YYYY/MM/DD
- **例：** 2026/01/11

#### 4.1.2 Googleカレンダーから取得

**取得条件：**
- プライマリカレンダー（`primary`）から取得
- 実行当日の0時00分～23時59分の予定を取得
- 終日イベントも含む
- 削除済みイベントは除外
- キャンセル済みイベントは除外

**取得データ：**
- 予定タイトル（大見出し）
- 開始時刻
- 終了時刻
- 終日フラグ

**表示形式：**
- 通常イベント：「・[予定タイトル] [開始時刻]-[終了時刻]」
  - 例：「・顧客訪問 10:00-11:00」
- 終日イベント：「・[予定タイトル]（終日）」
  - 例：「・出張（終日）」
- 予定が0件の場合：空の状態を表示
- 時刻の表示形式：HH:mm（24時間表記）

**取得処理の詳細：**
1. Calendar APIの`Events.list()`を使用
2. 取得期間：実行当日の00:00:00～23:59:59（JST基準）
3. タイムゾーン：Asia/Tokyo（JST）
4. ソート：開始時刻の昇順

### 4.2 データの表示

#### 4.2.1 表示形式

- WEBブラウザ上にテキストエリアで表示
- 編集可能なテキストエリア
- 予定データが複数行で表示される

#### 4.2.2 表示内容

- カレンダーから取得した予定データ
- 編集後のデータも同じエリアに表示

### 4.3 データの編集

#### 4.3.1 編集方法

- テキストエリアで直接編集
- 複数行の編集が可能
- 改行が保持される

#### 4.3.2 編集内容

- 予定データの追加・削除・変更が可能
- 自由形式のテキスト編集

### 4.4 コピー機能

#### 4.4.1 コピー方法

- 「コピー」ボタンをクリック
- クリップボードAPIを使用してテキストをコピー
- コピー成功時にメッセージを表示

#### 4.4.2 コピー内容

- テキストエリアに表示されているすべてのテキスト
- 編集後の内容も含む

### 4.5 Slack送信

#### 4.5.1 送信処理

**実行方法：**
- WEB画面の「Slackに投稿」ボタンをクリック

**送信処理フロー：**
1. テキストエリアの内容を取得
2. Slackチャンネル名を取得（入力または選択）
3. Webhook URLを取得（スクリプトプロパティまたは設定画面）
4. Slack投稿本文を生成
5. Slack Incoming Webhook APIにPOSTリクエストを送信
6. 送信成功時に成功メッセージを表示
7. 送信失敗時にエラーメッセージを表示

#### 4.5.2 Slack投稿本文の生成

**生成内容：**
- 日付（YYYY/MM/DD形式）
- テキストエリアの内容（予定データ）

**フォーマット例：**
```
【日報】2026/01/11

■ 本日のスケジュール
・顧客訪問 10:00-11:00
・会議 14:00-15:00
```

#### 4.5.3 Webhook URLの管理

- スクリプトプロパティに保存（推奨）
- または、WEB画面で入力（オプション）

#### 4.5.4 チャンネル名の指定

- WEB画面の入力フィールドで指定
- 形式：「#チャンネル名」（#から始まる）
- 例：「#daily-report」

## 5. データ定義

### 5.1 カレンダー予定データ

#### 5.1.1 データ構造

```javascript
{
  title: "予定タイトル",
  startTime: Date,  // 開始時刻
  endTime: Date,    // 終了時刻
  isAllDay: boolean // 終日フラグ
}
```

#### 5.1.2 データ形式

- **予定タイトル：** 文字列
- **開始時刻：** Dateオブジェクト（JST）
- **終了時刻：** Dateオブジェクト（JST）
- **終日フラグ：** boolean（true/false）

### 5.2 Slack投稿本文

#### 5.2.1 フォーマット定義

```
【日報】YYYY/MM/DD

■ 本日のスケジュール
[テキストエリアの内容]
```

#### 5.2.2 フォーマット規則

- 日付は「【日報】YYYY/MM/DD」形式
- 「■ 本日のスケジュール」という見出し
- テキストエリアの内容をそのまま使用
- 改行は保持される

### 5.3 設定データ

#### 5.3.1 スクリプトプロパティ

- `SLACK_WEBHOOK_URL`: Slack Incoming Webhook URL

## 6. システム構成・アーキテクチャ

### 6.1 システム構成図

```
┌─────────────────────────────────────────────────────────────┐
│                      ユーザー（ブラウザ）                      │
└───────────────────────┬─────────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────────┐
│              Google Apps Script (GAS)                        │
│  ┌──────────────────────────────────────────────────────┐  │
│  │      HTMLサービス（フロントエンド）                    │  │
│  │  ┌──────────────┐  ┌──────────────┐               │  │
│  │  │ 表示・編集画面 │  │ Slack送信フォーム│            │  │
│  │  └──────────────┘  └──────────────┘               │  │
│  └──────────────────────────────────────────────────────┘  │
│                                                              │
│  ┌──────────────────────────────────────────────────────┐  │
│  │      GASバックエンド（Code.gs）                       │  │
│  │  ┌──────────────┐  ┌──────────────┐               │  │
│  │  │ カレンダー取得  │  │ Slack送信    │            │  │
│  │  └──────────────┘  └──────────────┘               │  │
│  └──────────────────────────────────────────────────────┘  │
└───────────────────────┬─────────────────────────────────────┘
                        │
        ┌───────────────┴───────────────┐
        │                               │
        ▼                               ▼
┌───────────────┐              ┌───────────────┐
│ Google Calendar│              │  Slack API    │
│   (API)        │              │  (Webhook)    │
│                │              │               │
│ 予定データ取得  │              │ 日報投稿      │
└───────────────┘              └───────────────┘
```

### 6.2 データフロー図

```
【カレンダー予定取得フロー】

ユーザーが「今日の予定を取得」ボタンをクリック
  │
  ▼
HTML（フロントエンド）
  │ google.script.run.getTodayEvents()
  ▼
GASバックエンド（Code.gs）
  │ Calendar API呼び出し
  ▼
Google Calendar（予定データ取得）
  │
  ▼
GASバックエンド（データフォーマット）
  │
  ▼
HTML（フロントエンド：表示）
  │
  ▼
ユーザーがデータを確認・編集

【Slack送信フロー】

ユーザーが「Slackに投稿」ボタンをクリック
  │
  ▼
HTML（フロントエンド）
  │ テキストエリアの内容、チャンネル名を取得
  │ google.script.run.sendToSlack(text, channel)
  ▼
GASバックエンド（Code.gs）
  │ Slack投稿本文を生成
  │ Webhook URLを取得（スクリプトプロパティ）
  │ UrlFetchApp.fetch()でPOSTリクエスト
  ▼
Slack Webhook API
  │
  ▼
送信成功/失敗
  │
  ▼
HTML（フロントエンド：メッセージ表示）
```

### 6.3 処理フロー詳細

```
【getTodayEvents()関数の処理フロー】

1. 今日の日付を取得（YYYY/MM/DD形式）
2. Calendar APIで当日の予定を取得
   - CalendarApp.getCalendarById('primary')
   - getEvents(開始時刻, 終了時刻)
3. イベント情報を配列に変換
   - タイトル、開始時刻、終了時刻、終日フラグ
4. 開始時刻の昇順でソート
5. テキスト形式にフォーマット
6. フォーマット済みテキストを返却
7. HTML（フロントエンド）で表示

【sendToSlack(text, channel)関数の処理フロー】

1. スクリプトプロパティからWebhook URLを取得
2. 日付を取得（YYYY/MM/DD形式）
3. Slack投稿本文を生成
   - 「【日報】YYYY/MM/DD」
   - 「■ 本日のスケジュール」
   - テキストエリアの内容
4. リクエストボディを作成
   - channel: チャンネル名
   - text: 投稿本文
5. Slack Incoming Webhook APIにPOSTリクエスト送信
6. レスポンスをチェック
7. 成功/失敗のメッセージを返却
8. HTML（フロントエンド）でメッセージ表示
```

## 7. UI設計・操作フロー

### 7.1 WEB画面の構成

#### 7.1.1 画面レイアウト

```
┌─────────────────────────────────────────────────┐
│           簡単日報くん - 今日の予定取得              │
├─────────────────────────────────────────────────┤
│                                                  │
│  [今日の予定を取得] ボタン                       │
│                                                  │
│  ┌──────────────────────────────────────────┐  │
│  │ 予定データ表示・編集エリア（テキストエリア）│  │
│  │                                            │  │
│  │ ・顧客訪問 10:00-11:00                    │  │
│  │ ・会議 14:00-15:00                        │  │
│  │                                            │  │
│  │ （ここで編集可能）                         │  │
│  │                                            │  │
│  └──────────────────────────────────────────┘  │
│                                                  │
│  [コピー] ボタン                                │
│                                                  │
│  ┌──────────────────────────────────────────┐  │
│  │ Slack送信                                │  │
│  │ チャンネル: [#daily-report]              │  │
│  │ [Slackに投稿] ボタン                      │  │
│  └──────────────────────────────────────────┘  │
│                                                  │
│  （メッセージ表示エリア）                        │
│                                                  │
└─────────────────────────────────────────────────┘
```

#### 7.1.2 画面要素

**1. ヘッダー**
- タイトル：「簡単日報くん - 今日の予定取得」

**2. 予定取得ボタン**
- ボタン名：「今日の予定を取得」
- 機能：カレンダーから今日の予定を取得して表示

**3. テキストエリア**
- 用途：予定データの表示・編集
- サイズ：幅100%、高さ300px以上（スクロール可能）
- 編集：可（直接編集可能）

**4. コピーボタン**
- ボタン名：「コピー」
- 機能：テキストエリアの内容をクリップボードにコピー

**5. Slack送信フォーム**
- チャンネル名入力フィールド
- 送信ボタン：「Slackに投稿」

**6. メッセージ表示エリア**
- 成功/エラーメッセージを表示
- 自動で数秒後に消える（オプション）

### 7.2 操作フロー図

```
【基本操作フロー】

開始
  ↓
WEBアプリのURLにアクセス
  ↓
「今日の予定を取得」ボタンをクリック
  ↓
カレンダーから予定を取得
  ↓
テキストエリアに表示
  ↓
（オプション）データを編集
  ↓
（オプション）「コピー」ボタンでコピー
  ↓
チャンネル名を入力
  ↓
「Slackに投稿」ボタンをクリック
  ↓
Slackに送信
  ↓
成功メッセージ表示
  ↓
完了
```

## 8. API仕様・インターフェース

### 8.1 GASとHTML間の通信

#### 8.1.1 使用メソッド

- `google.script.run.functionName()`: GAS関数を呼び出し

#### 8.1.2 関数一覧

**getTodayEvents()**
- **説明：** 今日のカレンダー予定を取得
- **パラメータ：** なし
- **戻り値：** フォーマット済みテキスト（文字列）
- **エラー処理：** エラー時はエラーメッセージを返却

**sendToSlack(text, channel)**
- **説明：** Slackに投稿
- **パラメータ：**
  - `text`: 投稿本文（文字列）
  - `channel`: チャンネル名（文字列、例：「#daily-report」）
- **戻り値：** 成功/失敗メッセージ（文字列）
- **エラー処理：** エラー時はエラーメッセージを返却

### 8.2 Google Calendar API

#### 8.2.1 使用API

- **API名：** Google Calendar API
- **メソッド：** `CalendarApp.getCalendarById('primary').getEvents()`
- **認証：** OAuth 2.0（GASが自動処理）

#### 8.2.2 リクエストパラメータ

- `calendarId`: 'primary'（プライマリカレンダー）
- `startTime`: 実行当日の00:00:00（JST）
- `endTime`: 実行当日の23:59:59（JST）

### 8.3 Slack Incoming Webhook API

#### 8.3.1 使用API

- **API名：** Slack Incoming Webhook
- **メソッド：** POST
- **認証：** Webhook URL（スクリプトプロパティに保存）

#### 8.3.2 リクエストパラメータ

| パラメータ | 型 | 必須 | 説明 | 例 |
|------------|-----|------|------|-----|
| channel | string | YES | チャンネル名 | #daily-report |
| text | string | YES | 投稿本文 | 【日報】2026/01/11... |

#### 8.3.3 レスポンス

- **成功時：** HTTPステータス200、レスポンス本文「ok」
- **失敗時：** HTTPステータス400/404等、エラーメッセージ

## 9. 例外ケースとエラーハンドリング

### 9.1 カレンダー関連エラー

#### 9.1.1 カレンダーアクセス権限なし

- **エラー内容：** カレンダーにアクセスする権限がない
- **エラーメッセージ：** 「エラー：カレンダーへのアクセス権限がありません。権限を確認してください。」
- **対処方法：** GASの実行時に権限を付与

#### 9.1.2 カレンダー取得エラー

- **エラー内容：** カレンダーAPIの呼び出しに失敗
- **エラーメッセージ：** 「エラー：カレンダーから予定を取得できませんでした。しばらく時間をおいてから再度お試しください。」
- **対処方法：** 時間をおいて再試行

### 9.2 Slack送信関連エラー

#### 9.2.1 Webhook URL未設定

- **エラー内容：** スクリプトプロパティにWebhook URLが設定されていない
- **エラーメッセージ：** 「エラー：Slack Webhook URLが設定されていません。設定を確認してください。」
- **対処方法：** スクリプトプロパティにWebhook URLを設定

#### 9.2.2 Webhook URL無効

- **エラー内容：** Webhook URLが無効または期限切れ
- **エラーメッセージ：** 「エラー：Slack Webhook URLが無効です。設定を確認してください。」
- **対処方法：** SlackでWebhook URLを再作成

#### 9.2.3 チャンネル名無効

- **エラー内容：** チャンネル名の形式が正しくない
- **エラーメッセージ：** 「エラー：チャンネル名が無効です。#から始まる形式で入力してください。」
- **対処方法：** チャンネル名を「#チャンネル名」形式で入力

#### 9.2.4 送信失敗

- **エラー内容：** ネットワークエラー等で送信に失敗
- **エラーメッセージ：** 「エラー：Slackへの送信に失敗しました。ネットワーク接続を確認してください。」
- **対処方法：** ネットワーク接続を確認して再試行

### 9.3 その他のエラー

#### 9.3.1 予期しないエラー

- **エラー内容：** 予期しないエラーが発生
- **エラーメッセージ：** 「エラー：予期しないエラーが発生しました。詳細：[エラー内容]」
- **対処方法：** エラー内容を確認して対応

### 9.4 エラーメッセージ一覧

| エラーコード | エラーメッセージ | 発生タイミング |
|------------|----------------|--------------|
| ERR_CALENDAR_PERMISSION | エラー：カレンダーへのアクセス権限がありません。権限を確認してください。 | カレンダー取得時 |
| ERR_CALENDAR_FETCH | エラー：カレンダーから予定を取得できませんでした。しばらく時間をおいてから再度お試しください。 | カレンダー取得時 |
| ERR_WEBHOOK_URL_MISSING | エラー：Slack Webhook URLが設定されていません。設定を確認してください。 | Slack送信時 |
| ERR_WEBHOOK_URL_INVALID | エラー：Slack Webhook URLが無効です。設定を確認してください。 | Slack送信時 |
| ERR_CHANNEL_INVALID | エラー：チャンネル名が無効です。#から始まる形式で入力してください。 | Slack送信時 |
| ERR_SLACK_SEND_FAILED | エラー：Slackへの送信に失敗しました。ネットワーク接続を確認してください。 | Slack送信時 |
| ERR_UNEXPECTED | エラー：予期しないエラーが発生しました。詳細：[エラー内容] | 任意 |

## 10. 機能スコープ

### 10.1 MVPで実装する機能（やること）

1. **カレンダー予定の取得**
   - プライマリカレンダーから当日の予定を取得
   - テキスト形式でフォーマット

2. **WEB画面での表示**
   - HTMLサービスでWEBインターフェースを構築
   - テキストエリアで予定データを表示

3. **データの編集**
   - テキストエリアで直接編集可能

4. **コピー機能**
   - クリップボードAPIでテキストをコピー

5. **Slack送信**
   - Webhook URLを使用してSlackに投稿
   - チャンネル名を指定可能

6. **エラーハンドリング**
   - すべてのエラーケースに対する適切なエラーメッセージ表示

### 10.2 MVPではやらない（後回し・Won't）

1. KPIデータの取得・表示
2. データの永続化（スプレッドシート等への保存）
3. 過去のデータの履歴管理
4. 複数カレンダーの統合
5. カレンダーのカテゴリ分け
6. スケジュールの詳細情報（場所・説明等）の表示
7. 画像・ファイルの添付
8. 日報のテンプレートカスタマイズ
9. 日報のエクスポート機能（PDF、Excel等）
10. 日報の印刷機能
11. 複数ユーザー対応
12. 日報の承認ワークフロー
13. 日報のコメント機能
14. 自動送信機能（スケジュール実行）
15. モバイルアプリ版

## 11. 受け入れ条件

1. **WEBアプリとして動作**
   - GAS WEBアプリとしてデプロイできる
   - ブラウザからアクセスできる
   - 正常に画面が表示される

2. **カレンダー連携**
   - プライマリカレンダーから当日の予定を取得できる
   - 予定が0件の場合も正常に処理される
   - 終日イベントが正しく表示される
   - 予定のソート順が開始時刻の昇順になっている

3. **データの表示**
   - 取得した予定データがテキストエリアに表示される
   - フォーマットが正しい（タイトル、時刻）

4. **データの編集**
   - テキストエリアでデータを編集できる
   - 編集内容が反映される

5. **コピー機能**
   - 「コピー」ボタンでテキストエリアの内容をコピーできる
   - コピー成功時にメッセージが表示される

6. **Slack投稿本文の生成**
   - 正しいフォーマットで投稿本文が生成される
   - 日付が正しい形式（YYYY/MM/DD）で表示される
   - テキストエリアの内容が含まれる

7. **送信機能**
   - Webhook URLを設定するとSlackに送信できる
   - チャンネル名を指定できる
   - 送信成功時に成功メッセージが表示される

8. **エラーハンドリング**
   - カレンダーアクセス権限なし時、適切なエラーメッセージが表示される
   - Webhook URL未設定時、適切なエラーメッセージが表示される
   - すべてのエラーケースで処理が適切に中断される

9. **設定管理**
   - スクリプトプロパティにWebhook URLを設定できる
   - Webhook URLが正しく読み込める

10. **UI/UX**
    - ボタンがクリックできる
    - テキストエリアが編集できる
    - メッセージが表示される

## 12. NG例（動作上のNG）

1. カレンダー予定が取得できないのにエラーなく処理が継続する
2. カレンダーアクセス権限なしでエラーが表示されない
3. テキストエリアが編集できない
4. コピーボタンが動作しない
5. Slack送信時にWebhook URLが未設定でもエラーが表示されない
6. チャンネル名の形式が不正でも送信できてしまう
7. 送信失敗時にエラーが表示されない
8. エラーメッセージが分かりにくい（技術的なメッセージのみ）
9. 終日イベントが通常イベントと同じ形式で表示される
10. 予定のソート順が不定（開始時刻の昇順でない）
11. ブラウザを閉じた後に編集内容が残ってしまう（データ永続化は不要）

## 13. 実装方針

### 13.1 Google Apps Script（GAS）の構成

#### 13.1.1 ファイル構成

**Code.gs（バックエンド）**
- カレンダー予定取得関数
- Slack送信関数
- スクリプトプロパティ管理関数

**Index.html（フロントエンド）**
- HTML構造
- CSSスタイル
- JavaScript（GASとの通信、UI制御）

#### 13.1.2 関数構成

**バックエンド関数（Code.gs）：**

- `doGet()`: WEBアプリのエントリーポイント、HTMLを返却
- `getTodayEvents()`: 今日のカレンダー予定を取得（戻り値：フォーマット済みテキスト）
- `sendToSlack(text, channel)`: Slackに投稿（戻り値：成功/失敗メッセージ）
- `getWebhookUrl()`: スクリプトプロパティからWebhook URLを取得（戻り値：URL文字列）
- `setWebhookUrl(url)`: スクリプトプロパティにWebhook URLを設定（オプション）
- `formatScheduleText(events)`: イベント配列をテキスト形式にフォーマット（戻り値：文字列）
- `formatSlackMessage(date, text)`: Slack投稿本文を生成（戻り値：文字列）
- `getTodayDateString()`: 今日の日付をYYYY/MM/DD形式で取得（戻り値：文字列）

**フロントエンド（Index.html内のJavaScript）：**

- `loadEvents()`: 「今日の予定を取得」ボタンクリック時の処理
- `copyToClipboard()`: 「コピー」ボタンクリック時の処理
- `sendToSlack()`: 「Slackに投稿」ボタンクリック時の処理
- `showMessage(message, isError)`: メッセージを表示

#### 13.1.3 定数定義

```javascript
// スクリプトプロパティキー
const PROPERTY_WEBHOOK_URL = 'SLACK_WEBHOOK_URL';

// タイムゾーン
const TIMEZONE = 'Asia/Tokyo';

// 日付フォーマット
const DATE_FORMAT = 'yyyy/MM/dd';
const TIME_FORMAT = 'HH:mm';
```

#### 13.1.4 WEBアプリのデプロイ

- GASエディタで「デプロイ」→「新しいデプロイ」
- 種類：「ウェブアプリ」を選択
- 設定：
  - 説明：任意
  - 次のユーザーとして実行：自分
  - アクセスできるユーザー：全員（または自分のみ）

### 13.2 実装手順

1. GASプロジェクトを作成
2. Code.gsにバックエンド関数を実装
3. Index.htmlを作成し、フロントエンドを実装
4. スクリプトプロパティにWebhook URLを設定
5. WEBアプリとしてデプロイ
6. 動作確認

## 14. テスト項目

### 14.1 正常系テスト

#### テストケース1：カレンダー予定あり、正常に取得・表示

**前提条件：**
- プライマリカレンダーに当日の予定が2件以上存在

**テスト手順：**
1. WEBアプリのURLにアクセス
2. 「今日の予定を取得」ボタンをクリック
3. テキストエリアに予定が表示されることを確認

**期待結果：**
- 予定が正しく表示される
- フォーマットが正しい（タイトル、時刻）
- ソート順が開始時刻の昇順

#### テストケース2：カレンダー予定なし

**前提条件：**
- プライマリカレンダーに当日の予定が0件

**テスト手順：**
1. WEBアプリのURLにアクセス
2. 「今日の予定を取得」ボタンをクリック
3. テキストエリアの状態を確認

**期待結果：**
- エラーにならない
- テキストエリアが空の状態

#### テストケース3：データの編集

**前提条件：**
- カレンダー予定が取得され、表示されている

**テスト手順：**
1. テキストエリアでデータを編集
2. 編集内容が反映されることを確認

**期待結果：**
- 編集ができる
- 編集内容が正しく反映される

#### テストケース4：コピー機能

**前提条件：**
- テキストエリアにデータが表示されている

**テスト手順：**
1. 「コピー」ボタンをクリック
2. 他のアプリケーションに貼り付けて確認

**期待結果：**
- コピーが成功する
- 貼り付けができる
- コピー成功メッセージが表示される

#### テストケース5：Slack送信成功

**前提条件：**
- Webhook URLが正しく設定されている
- テキストエリアにデータが表示されている（編集後でも可）

**テスト手順：**
1. チャンネル名を入力（例：「#daily-report」）
2. 「Slackに投稿」ボタンをクリック
3. Slackで投稿を確認

**期待結果：**
- 送信が成功する
- Slackに正しい内容が投稿される
- 成功メッセージが表示される

### 14.2 異常系テスト

#### テストケース6：カレンダーアクセス権限なし

**前提条件：**
- カレンダーへのアクセス権限がない

**テスト手順：**
1. WEBアプリのURLにアクセス
2. 「今日の予定を取得」ボタンをクリック

**期待結果：**
- エラーメッセージが表示される
- 処理が中断される

#### テストケース7：Webhook URL未設定

**前提条件：**
- スクリプトプロパティにWebhook URLが設定されていない

**テスト手順：**
1. テキストエリアにデータを表示
2. チャンネル名を入力
3. 「Slackに投稿」ボタンをクリック

**期待結果：**
- エラーメッセージが表示される
- 送信が失敗する

#### テストケース8：Webhook URL無効

**前提条件：**
- スクリプトプロパティに無効なWebhook URLが設定されている

**テスト手順：**
1. テキストエリアにデータを表示
2. チャンネル名を入力
3. 「Slackに投稿」ボタンをクリック

**期待結果：**
- エラーメッセージが表示される
- 送信が失敗する

#### テストケース9：チャンネル名無効

**前提条件：**
- Webhook URLが正しく設定されている

**テスト手順：**
1. テキストエリアにデータを表示
2. 無効なチャンネル名を入力（例：「daily-report」、#なし）
3. 「Slackに投稿」ボタンをクリック

**期待結果：**
- エラーメッセージが表示される
- 送信が失敗する

#### テストケース10：ネットワークエラー

**前提条件：**
- ネットワーク接続が不安定

**テスト手順：**
1. テキストエリアにデータを表示
2. チャンネル名を入力
3. 「Slackに投稿」ボタンをクリック

**期待結果：**
- エラーメッセージが表示される
- 送信が失敗する

## 15. 完了条件

以下のすべてが満たされた場合、MVP完成とする：

1. **動作確認**
   - テスト項目（正常系・異常系）をすべて実行し、期待通りの動作を確認
   - すべてのテストケースがパスする

2. **仕様適合**
   - 受け入れ条件10項目すべてをクリア
   - NG例が発生しない

3. **ドキュメント**
   - 使用方法の説明が記載されている
   - 設定方法が明確に記載されている

4. **運用準備**
   - Webhook URLの設定方法が明確
   - エラーメッセージが分かりやすい

## 16. ログ・デバッグ方針

### 16.1 ログ出力

- **エラー発生時：** `Logger.log()`でエラー内容を記録
- **主要な処理開始・終了時：** ログを出力
  - 例：「カレンダー予定取得開始」
  - 例：「カレンダー予定取得完了：2件」
  - 例：「Slack送信開始」
  - 例：「Slack送信完了」

### 16.2 デバッグ方法

- GASエディタの「表示」→「ログ」でログを確認
- ブラウザの開発者ツール（F12）でJavaScriptエラーを確認

## 17. エラー方針

- すべてのエラーはユーザーに分かりやすい日本語メッセージで表示
- エラー発生時は処理を中断
- エラーメッセージはWEB画面に表示

## 18. セキュリティ要件

- Webhook URLはスクリプトプロパティに保存（コードに直接書かない）
- アクセス権限は必要最小限に設定
- ユーザー入力のサニタイズ（必要に応じて）

## 19. パフォーマンス要件・制限事項

- カレンダー予定取得は5秒以内に完了すること
- Slack送信は3秒以内に完了すること
- GASの実行時間制限（6分）以内に処理が完了すること

## 20. 運用・保守要件

### 20.1 初期設定

- GASプロジェクトを作成
- スクリプトプロパティにWebhook URLを設定
- WEBアプリとしてデプロイ
- URLをユーザーに共有

### 20.2 設定変更

- Webhook URLの変更：スクリプトプロパティを編集

### 20.3 トラブルシューティング

**問題：カレンダー予定が取得できない**
- カレンダーへのアクセス権限を確認
- GASの実行ログを確認

**問題：Slack送信が失敗する**
- Webhook URLが正しく設定されているか確認
- チャンネル名が正しい形式か確認（#から始まる）
- ネットワーク接続を確認

## 21. 用語集

| 用語 | 説明 |
|------|------|
| GAS | Google Apps Scriptの略。Googleサービスを自動化するスクリプト |
| HTMLサービス | GASが提供するWEBアプリ構築機能 |
| Webhook | アプリケーション間でイベントを通知する仕組み。Slack Incoming Webhookは、HTTP POSTリクエストでメッセージを送信する |
| プライマリカレンダー | Googleアカウントのデフォルトカレンダー（calendarId: 'primary'） |
| 終日イベント | 開始時刻と終了時刻が設定されていない、1日全体のイベント |
| スクリプトプロパティ | GASで設定値を安全に保存する機能 |
| MVP | Minimum Viable Product（最小実行可能製品）の略。最小限の機能で価値を提供する製品 |

## 22. 実装上の注意事項・ベストプラクティス

### 22.1 コーディング規約

- **変数名：** camelCaseを使用（例：`calendarId`, `webhookUrl`）
- **定数名：** UPPER_SNAKE_CASEを使用（例：`PROPERTY_WEBHOOK_URL`）
- **関数名：** camelCaseを使用（例：`getTodayEvents`, `sendToSlack`）
- **コメント：** 複雑なロジックには日本語コメントを追加
- **エラーハンドリング：** すべての外部API呼び出しにtry-catchを使用

### 22.2 データ整合性チェック

**カレンダー取得時：**
- カレンダーアクセス権限の確認
- 取得したデータの検証

**Slack送信時：**
- Webhook URLの存在確認
- チャンネル名の形式確認（#から始まる）
- 送信成功の確認

### 22.3 エラーハンドリングのベストプラクティス

1. **早期リターン：** エラー検出時は即座に処理を中断
2. **エラーメッセージ：** ユーザーに分かりやすい日本語で表示
3. **ログ記録：** 開発者向けの詳細情報をLogger.log()で記録

### 22.4 UI/UXのベストプラクティス

- ボタンクリック時にローディング表示
- エラーメッセージは明確に表示
- 成功メッセージも表示
- レスポンシブデザインを考慮（オプション）

## 23. コードレビューチェックリスト

- [ ] すべての関数にエラーハンドリングがある
- [ ] エラーメッセージが分かりやすい日本語で記載されている
- [ ] スクリプトプロパティにWebhook URLを保存している（コードに直接書いていない）
- [ ] カレンダー予定が開始時刻の昇順でソートされている
- [ ] 終日イベントが正しく処理されている
- [ ] コピー機能が正常に動作する
- [ ] Slack送信が正常に動作する
- [ ] すべてのテストケースがパスする

## 24. デバッグ手順詳細

### 24.1 デバッグの準備

1. GASエディタを開く
2. 「表示」→「ログ」でログ表示を有効化

### 24.2 ログの確認方法

1. WEBアプリで操作を実行
2. GASエディタのログを確認
3. エラー内容を確認

### 24.3 デバッグのポイント

**カレンダー予定が取得できない場合：**
1. Logger.log()でカレンダーアクセス権限を確認
2. Logger.log()で取得したイベント数を確認
3. カレンダーに当日の予定が存在するか確認

**Slack送信が失敗する場合：**
1. Logger.log()でWebhook URLが正しく取得できているか確認
2. Logger.log()でSlack投稿本文が正しく生成されているか確認
3. HTTPレスポンスコードを確認（200 OK以外の場合はエラー）

**エラーメッセージが表示される場合：**
1. エラーメッセージの内容を確認
2. Logger.log()でエラー発生箇所を特定
3. エラー原因を解決

## 25. 参考資料

- [Google Apps Script公式ドキュメント](https://developers.google.com/apps-script)
- [HTMLサービス公式ドキュメント](https://developers.google.com/apps-script/guides/html)
- [Google Calendar API公式ドキュメント](https://developers.google.com/calendar/api)
- [Slack Incoming Webhooks公式ドキュメント](https://api.slack.com/messaging/webhooks)

---

## 26. V2（テンプレート変更＋入力欄追加＋翌日引き継ぎ）仕様

### 26.1 目的・位置づけ

- V2は現行MVP（V1）の後継として、**V2を標準**として運用する（V1は置き換え）。
- V2の主目的は以下：
  - **テンプレート統一**（4セクション）
  - **必須バリデーション**（全セクション必須）
  - **翌日引き継ぎ**（「次すること」を翌日に自動表示）

#### 26.1.1 前提条件

- Googleアカウントでログインしている
- Googleカレンダーにアクセス権限がある
- Slack Incoming Webhook URL が設定済み（本書「9.2 Slack関連のエラー」に従う）
- タイムゾーンはJST（Asia/Tokyo）で扱う

### 26.2 テンプレート（画面表示・コピー・Slack投稿で完全一致）

V2は、**画面表示・コピー・Slack投稿の本文が完全一致**すること（表記ゆれ無し）。

- 入力UIはWYSIWYG（リッチテキスト）でもよいが、**コピー・Slack投稿に使用する本文はプレーンテキスト**とする（HTMLタグを含めない）
- 箇条書き記号は **「⚫︎」** に統一する

```
【YYYY年MM月DD日　氏名　日報】

【今日やったこと】
⚫︎
⚫︎
⚫︎

【わかった事・問題・共有事項】
⚫︎
⚫︎
⚫︎

【売上・利益・経費削減に関わるポイント】
⚫︎
⚫︎
⚫︎

【次すること】
⚫︎
⚫︎
⚫︎
```

### 26.3 日付・氏名の仕様

#### 26.3.1 日付

- **基準**：JST（Asia/Tokyo）
- **形式**：`YYYY年MM月DD日`

#### 26.3.2 氏名

- **自動取得**：Googleアカウントから取得する
- **フォールバック**
  - 自動取得できない場合は、手動入力を促す（「氏名を自動取得できませんでした。手動で入力してください。」）

### 26.4 「今日やったこと」（カレンダー予定）の反映

- **初期表示**：ページ初期表示で、当日のカレンダー予定を自動反映する（編集可能）
- **再取得**：「今日の予定を取得」ボタンは残し、押下時は当日のカレンダー予定を再取得して反映する（再取得用途）
- **対象日・取得期間・タイムゾーン**：本書の「4.1 カレンダー予定の取得」に従う（JST基準）
- **備考**：本書「3.1 ユースケース1（カレンダー予定の取得と表示）」はV1（ボタン押下で取得）を前提としているが、V2では初期表示で自動取得する点が異なる

### 26.5 必須バリデーション（V2）

#### 26.5.1 対象

以下の4セクションをすべて必須とする：

- 今日やったこと
- わかった事・問題・共有事項
- 売上・利益・経費削減に関わるポイント
- 次すること

#### 26.5.2 ルール

- 各セクションは **1文字以上**の入力が必要
- **空白・改行のみ**は未入力扱い（トリム後に判定）
- 未入力がある場合は、エラーメッセージを表示し送信を中断する
  - メッセージ例：「未入力の項目があります。全ての項目を入力してください。」

### 26.6 Slack送信（V2）

#### 26.6.1 方式

- **Slack Incoming Webhook** を使用する（OAuth方式は採用しない）
- Webhook URLの取り扱い・エラーは本書「9.2 Slack関連のエラー」に従う
- 送信先チャンネルは **Webhook側の設定に従う**（アプリ側でのチャンネル選択・Slack連携（認可）は行わない）

#### 26.6.2 投稿本文

- 26.2のテンプレートと完全一致
- 改行は保持する

### 26.7 翌日引き継ぎ（「次すること」）

#### 26.7.1 保存する内容

- 保存対象：**「次すること」**のみ
- 保存先：Script Properties（UserProperties）
- 保存タイミング：**Slack送信成功時のみ**
- 同日複数回送信：**最後に送信した内容で上書き（last send wins）**
- 保持期間：削除は行わず、次回のSlack送信成功で上書きされるまで保持する（表示しただけでは消えない）

#### 26.7.2 データ形式

- キー名：`NEXT_TASKS_DATA`
- 形式：JSON文字列

例：

```json
{
  "date": "2026-01-24",
  "nextTasks": "⚫︎ タスク1\n⚫︎ タスク2\n⚫︎ タスク3"
}
```

#### 26.7.3 表示ルール（直近送信日まで遡る）

ページ初期表示時に、UserPropertiesから `NEXT_TASKS_DATA` を読み込む。

- データが存在しない場合：空欄（正常）
- データが破損（JSON不正）の場合：空欄（正常）＋エラーログ記録
- データの日付が「今日」の場合：空欄（すでに今日の送信で保存済みのため）
- 上記以外の場合：保存されている `nextTasks` を「次すること」に初期表示する
  - この仕様により、前日が未送信であっても **直近の送信日**の内容が表示される

### 26.8 例外ケース（V2）

| No | 例外ケース | 発生条件 | 対応方針 | エラーメッセージ |
|----|------------|----------|----------|------------------|
| 1 | 氏名の自動取得失敗 | 権限不足等 | 手動入力を促す | 「氏名を自動取得できませんでした。手動で入力してください。」 |
| 2 | 引き継ぎデータなし | 初回利用、未送信 | 空欄表示（正常） | なし |
| 3 | 引き継ぎデータ破損 | JSON不正 | 空欄表示＋ログ | なし |
| 4 | 引き継ぎ取得失敗 | PropertiesServiceの取得失敗等 | 空欄表示（正常）＋ログ | なし |

### 26.9 受け入れ条件（V2）

1. V2テンプレート（4セクション）が画面に表示される
2. ヘッダーに「日付（YYYY年MM月DD日）」と「氏名」が表示される（JST基準）
3. ページ初期表示で「今日やったこと」に当日のカレンダー予定が自動反映される
4. 「今日の予定を取得」ボタンで当日の予定を再取得できる
5. 4セクションのいずれかが未入力（空白のみ含む）の場合、Slack送信ができずエラーが表示される
6. コピー結果が26.2テンプレート形式になる（画面表示・コピー・Slack投稿が完全一致）
7. Slack投稿が26.2テンプレート形式で送信される（Incoming Webhook）
8. Slack送信成功時、「次すること」がUserPropertiesに保存される
9. 翌日（または直近送信日から日付が変わったタイミング）にアクセスすると、保存された「次すること」が初期表示される
10. 同日に複数回送信した場合、最後に送信した「次すること」が翌日に引き継がれる

### 26.10 NG例（V2）

- 画面とSlackで見出し文言や記号が一致しない（表記ゆれ）
- 「売上・利益・経費削減に関わるポイント」の見出しが旧名称のまま残る
- 空白・改行のみでバリデーションを通過して送信できてしまう
- 引き継ぎが「前日限定」になっており、直近の送信日まで遡れない
- Slack送信がOAuth方式（chat.postMessage等）になっている

### 26.11 完了条件（V2）

- 26.9の受け入れ条件をすべて満たす
- 26.10のNG例が発生しない

---

## 27. V3（ツール連携：Slack/Gmail/Notion＋日付指定UI）仕様

### 27.1 目的・位置づけ

- V3はV2の機能を全て維持した上で、**Slack・Gmail・Notionの利用履歴を自動取得**して「今日やったこと」に表示する。
- さらに、**日付指定UI**を復活させ、カレンダー予定を指定日で取得できるようにする。
- これにより、日報は「書く」から「確認して送る」に変わる。

#### 27.1.1 前提条件

| No | 前提条件 | 確認方法 |
|----|----------|----------|
| 1 | V2が完成・稼働している | V2動作確認済み |
| 2 | Slack OAuth連携が可能（既存コードを履歴取得用として復活利用） | `src/Code.gs` に `getSlackUserToken_` 等が残存 |
| 3 | Googleアカウントでログイン済み（Gmail用） | GASで自動認証 |
| 4 | Notion Integration Tokenが設定可能（SEC-01対象） | Script Propertiesに手動投入 |
| 5 | Slack Incoming Webhook URLが設定済み（V2から継続） | 日報送信はWebhookのまま |

### 27.2 機能一覧

| No | 機能ID | 機能名 | 概要 | 難易度 |
|----|--------|--------|------|:------:|
| 1 | V3-F1 | 日付指定UI | カレンダー予定を指定日で取得できる（年/月/日セレクト＋前日/翌日ボタン） | 低 |
| 2 | V3-A1 | Slack履歴の自動取得 | 当日のSlack投稿・DM件名を自動取得（OAuth＋`search:read`スコープ） | 高 |
| 3 | V3-A2 | Gmail履歴の自動取得 | 当日の送信メール件名を自動取得（GmailApp、受信はデフォルトOFF） | 高 |
| 4 | V3-A6 | Notion履歴の自動取得 | 当日の編集/作成ページタイトルを自動取得（Notion API） | 高 |
| 5 | V3-S1 | ツールON/OFF設定 | 各ツール（Slack/Gmail/Notion）のON/OFFを個別設定できるUI | 低 |

### 27.3 Slack認証方針（送信と履歴の共存）

V3では **Slack OAuthを「履歴取得専用」として復活利用**する。日報送信はV2で確定した **Incoming Webhook** のまま維持する。

| 用途 | 方式 | 根拠 |
|------|------|------|
| 日報送信（Slackに投稿） | Incoming Webhook（`SLACK_WEBHOOK_URL`） | V2で確定済み（26章） |
| Slack履歴取得 | Slack OAuth（ユーザートークン＋`search:read`スコープ） | V3で復活 |

- `src/Code.gs` に残存する `getSlackUserToken_()`, `getSlackAuthorizeUrl()`, `handleSlackOAuthCallback_()` を履歴取得専用として復活利用する。
- 既存スコープ `chat:write` に **`search:read`** を追加する（再認可フローが必要）。
- Slack OAuthの「Slack連携（認可）」ボタンをUIに復活させる（履歴取得に必要な場合のみ表示）。

### 27.4 日付指定UIの仕様

| 項目 | 仕様 |
|------|------|
| 対象 | **カレンダー予定のみ**（Slack/Gmail/Notionは常に「今日」） |
| UI要素 | 年/月/日セレクトボックス＋前日/翌日ボタン（`src/Index.html` のコメントアウトされている既存UIを復活） |
| デフォルト | 今日の日付 |
| 動作 | 日付変更時に `getEventsForDate(dateString)` を呼び出し、カレンダー予定のみ更新 |
| 「今日の予定を取得」ボタン | 残す（日付ピッカーで選んだ日のカレンダー予定を取得） |

### 27.5 各ツールの取得仕様

#### 27.5.1 Slack履歴

| 項目 | 仕様 |
|------|------|
| 取得対象 | 自分が投稿したメッセージ（当日分）＋DM（件名のみ表示、内容は非表示） |
| 取得しない対象 | 他人の投稿（自分が関与していないもの）、削除済みメッセージ |
| DM表示 | チャンネル名を「DM」と表示、メッセージ内容は30文字に短縮 |
| 取得件数上限 | 最大50件 |
| API | Slack Web API `search.messages`（`from:me`クエリ） |
| 認証 | Slack OAuth ユーザートークン＋`search:read`スコープ |
| 表示形式 | `⚫︎ [Slack] #チャンネル名: 「メッセージ概要」` |

#### 27.5.2 Gmail履歴

| 項目 | 仕様 |
|------|------|
| 取得対象 | 自分が送信したメール（当日分） |
| 受信メール | **デフォルトOFF**（ユーザーがON/OFF設定で変更可能） |
| 取得しない対象 | スパム、ゴミ箱、自動生成メール |
| 取得件数上限 | 最大50件 |
| API | GmailApp.search()（GASネイティブ、追加認証不要） |
| 表示形式 | `⚫︎ [Gmail] 送信: 「件名」` / `⚫︎ [Gmail] 受信(送信者): 「件名」` |

#### 27.5.3 Notion履歴

| 項目 | 仕様 |
|------|------|
| 取得対象 | 自分が編集/作成したページ（当日分） |
| 取得しない対象 | 他人が編集したページ、削除済みページ |
| 取得件数上限 | 最大50件 |
| API | Notion API `search`エンドポイント |
| 認証 | Notion Integration Token（Script Propertiesに保存、SEC-01対象） |
| 表示形式 | `⚫︎ [Notion] 編集: 「ページタイトル」` / `⚫︎ [Notion] 作成: 「ページタイトル」` |

### 27.6 表示順（「今日やったこと」内）

**ツールごとにグループ表示**（混合時系列ではない）：

1. **カレンダー予定**（指定日 or 当日）
2. **Slack履歴**（当日）
3. **Gmail履歴**（当日）
4. **Notion履歴**（当日）

各グループ内は時刻の昇順。

### 27.7 ツールON/OFF設定

| 項目 | 仕様 |
|------|------|
| UI | チェックボックス（Slack / Gmail / Gmail受信 / Notion） |
| 保存先 | UserProperties（`TOOL_SETTINGS`キー） |
| 保存形式 | JSON: `{"slack": true, "gmail": true, "gmailReceived": false, "notion": true}` |
| デフォルト | Slack: ON, Gmail（送信）: ON, Gmail（受信）: **OFF**, Notion: ON |
| 反映タイミング | 保存後、次回の履歴取得から反映 |

### 27.8 データ定義

| データ | 保存先 | キー名 | 形式 | SEC-01対象 |
|--------|--------|--------|------|:----------:|
| ツールON/OFF設定 | UserProperties | `TOOL_SETTINGS` | JSON | No |
| Notion Integration Token | ScriptProperties | `NOTION_INTEGRATION_TOKEN` | 文字列 | **Yes** |
| Slack OAuth関連 | ScriptProperties | `SLACK_CLIENT_ID`, `SLACK_CLIENT_SECRET` | 文字列 | **Yes**（既存） |
| Slack ユーザートークン | UserProperties | （既存の保存キー） | 文字列 | **Yes**（既存） |
| Slack ユーザーID | UserProperties | `SLACK_USER_ID` | 文字列 | No |

### 27.9 SEC-01対象（シークレット）

この工程ではシークレット情報が必要になる可能性があります。SEC-01 で停止します。

| シークレット | 投入先 | 投入方法 |
|------------|--------|----------|
| Notion Integration Token | ScriptProperties `NOTION_INTEGRATION_TOKEN` | GAS「プロジェクトの設定」→「スクリプトプロパティ」で手動投入 |
| Slack追加スコープ（`search:read`） | Slack App管理画面 | User Token Scopesに`search:read`を追加→ユーザー再認可 |

### 27.10 例外ケース

| No | 例外ケース | 発生条件 | 対応方針 | エラーメッセージ |
|----|------------|----------|----------|------------------|
| 1 | Slack追加スコープ未認可 | ユーザーが拒否 | Slack履歴のみ取得しない（他は動作） | 「Slack履歴の取得には追加の権限が必要です。」 |
| 2 | Gmail API エラー | API制限、権限不足 | Gmail履歴のみ取得しない | 「Gmail履歴を取得できませんでした。」 |
| 3 | Notion Token未設定 | 管理者未設定 | Notion履歴のみ取得しない | 「Notion連携が設定されていません。」 |
| 4 | Notion API エラー | API制限、権限不足 | Notion履歴のみ取得しない | 「Notion履歴を取得できませんでした。」 |
| 5 | 取得データが大量 | 1日に50件超 | 最新50件に絞る | なし（自動で絞り込み） |
| 6 | 1ツール失敗 | 任意のツールでエラー | **他ツールは正常動作**（独立エラーハンドリング） | ツール名付きエラーメッセージ |

### 27.11 NG例（V3）

| No | NG例 | 理由 |
|----|------|------|
| 1 | Slack DMの内容（本文全文）が表示される | プライバシー侵害（件名/概要30文字のみ許可） |
| 2 | 他人のメッセージ/メールが取得される | 対象外データ |
| 3 | 1ツールの認証エラーでアプリ全体が動かなくなる | 影響範囲の限定が必須 |
| 4 | 取得に30秒以上かかる | UX悪化 |
| 5 | V2機能（テンプレ/バリデーション/引き継ぎ/Webhook送信）が動かなくなる | 後方互換性 |
| 6 | 日付指定でSlack/Gmail/Notionの過去日データが取得される | 仕様外（常に今日） |

### 27.12 非機能要件（V3）

| No | カテゴリ | 要件 | 基準値 |
|----|----------|------|--------|
| 1 | パフォーマンス | 全ツール取得合計時間 | 15秒以内 |
| 2 | パフォーマンス | 各ツール個別取得時間 | 5秒以内 |
| 3 | 可用性 | 1ツール失敗時 | 他ツールは正常動作 |
| 4 | セキュリティ | トークン保存 | Script Properties |
| 5 | セキュリティ | DMコンテンツ | 30文字に短縮のみ |
| 6 | 互換性 | V2機能 | 全て維持 |

### 27.13 受け入れ条件（V3）

| No | 受け入れ条件 | 確認方法 |
|----|--------------|----------|
| 1 | 日付指定UIが表示され、指定日のカレンダー予定を取得できる | 画面操作で確認 |
| 2 | Slack履歴が「今日やったこと」にグループ表示される | 画面確認 |
| 3 | Gmail履歴（送信のみ）が「今日やったこと」にグループ表示される | 画面確認 |
| 4 | Notion履歴が「今日やったこと」にグループ表示される | 画面確認 |
| 5 | 表示順がカレンダー→Slack→Gmail→Notionのグループ順になっている | 画面確認 |
| 6 | 各ツールのON/OFFが設定でき、保存・反映される | 設定画面確認 |
| 7 | 1ツールが失敗しても他ツールは正常動作する | 異常系テスト |
| 8 | V2機能（テンプレ/バリデーション/引き継ぎ/Webhook送信/コピー）が正常動作する | V2テスト再実行 |
| 9 | Slack DM取得時、件名（30文字概要）のみ表示され内容全文は表示されない | 画面確認 |
| 10 | 日付指定でカレンダーのみ変わり、Slack/Gmail/Notionは常に今日のデータ | 画面確認 |

### 27.14 完了条件（V3）

- 27.13の受け入れ条件をすべて満たす
- 27.11のNG例が発生しない

