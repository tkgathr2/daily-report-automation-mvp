# 日報自動生成システム MVP 要件定義書・仕様書

## 0. ドキュメント情報

| 項目 | 内容 |
|------|------|
| 文書名 | 日報自動生成システム MVP 要件定義書・仕様書 |
| バージョン | 1.0 |
| 作成日 | 2026-01-11 |
| 最終更新日 | 2026-01-11 |
| 作成者 | - |
| 承認者 | - |
| 改定履歴 | v1.0: 初版作成 |

## 1. 目的・背景

### 1.1 目的

Googleカレンダーと営業KPIシートから情報を取得し、
日報の下書きを自動生成 → 編集 → ワンクリックでSlack送信できるMVPを作る。

### 1.2 背景・課題

- 日報作成に時間がかかる
- カレンダーとKPIシートの情報を手動で転記する必要がある
- 日報のフォーマット統一が困難
- 日報の送信漏れが発生する可能性がある

### 1.3 期待される効果

- 日報作成時間の短縮
- 情報の転記ミス削減
- 日報フォーマットの統一
- 送信漏れの防止

## 2. 対象ツール・環境

### 2.1 使用ツール

- Google Calendar（予定取得）
- Google Spreadsheet（データ管理）
- Google Apps Script（GAS）（自動化スクリプト）
- Slack Incoming Webhook（日報送信）

### 2.2 前提条件・制約事項

#### 2.2.1 環境要件

- Googleアカウントが必要（Gmailアカウント、Google Workspaceアカウントのいずれか）
- Googleスプレッドシートの編集権限が必要
- Googleカレンダーへのアクセス権限が必要
- Slackワークスペースへのアクセス権限が必要
- Slack Incoming Webhookの作成権限が必要

#### 2.2.2 技術的制約

- GASの実行時間制限：6分（無料版）
- GASの実行回数制限：1日あたり20,000回（無料版）
- Calendar APIの利用制限：1秒あたり250クエリ
- Slack Webhookの送信制限：1秒あたり1リクエスト（推奨）

#### 2.2.3 データ制約

- スプレッドシートのシート数：3シート固定（KPI、DailyReport_Draft、Config）
- 1日あたり1行の日報データ
- 日付の重複不可

#### 2.2.4 運用制約

- 当日の日報のみ自動生成対象
- 過去日の日報は手動編集可能
- 送信済みの日報は再送信不可（フラグを手動で変更すれば可能）

## 3. ユースケース・ユーザーストーリー

### 3.1 ユースケース1：日報下書きの自動生成

**アクター：** 営業担当者

**前提条件：**
- スプレッドシートが正しく設定されている
- カレンダーIDがConfigシートに設定されている
- KPIシートに当日のデータが入力されている

**基本フロー：**
1. ユーザーがスプレッドシートを開く
2. メニューから「日報生成」を選択（またはボタンをクリック）
3. システムが当日のカレンダー予定を取得
4. システムが当日のKPIデータを取得
5. システムがDailyReport_Draftシートに下書きを生成
6. ユーザーが下書きを確認

**例外フロー：**
- 3a. カレンダーIDが無効：エラーメッセージ表示、処理中断
- 4a. KPIデータが存在しない：エラーメッセージ表示、処理中断
- 5a. 同日の日報が既に存在：既存行を上書き

### 3.2 ユースケース2：日報の編集

**アクター：** 営業担当者

**前提条件：**
- 日報下書きが生成されている

**基本フロー：**
1. ユーザーがDailyReport_Draftシートを開く
2. 該当日の行を選択
3. ユーザーが「上手く行ったこと」「上手く行かなかったこと」「明日やること」を入力
4. ユーザーが入力内容を確認

### 3.3 ユースケース3：Slack送信

**アクター：** 営業担当者

**前提条件：**
- 日報下書きが生成されている
- 手入力欄の入力は任意（空欄でも可）
- 送信済みフラグがFALSE

**基本フロー：**
1. ユーザーがDailyReport_Draftシートを開く
2. ユーザーがメニューから「日報送信」を選択（またはボタンをクリック）
3. システムが送信済みフラグをチェック
4. システムがSlack投稿本文を生成
5. システムがSlackに送信
6. システムが送信済みフラグをTRUEに更新
7. システムが送信日時を記録
8. ユーザーがSlackで日報を確認

**例外フロー：**
- 3a. 送信済みフラグがTRUE：エラーメッセージ表示、送信ブロック
- 4a. Webhook URLが無効：エラーメッセージ表示、処理中断
- 5a. 送信失敗：エラーメッセージ表示、送信済みフラグは更新しない

## 4. 機能要件

### 4.1 日報下書きの自動生成

#### 4.1.1 対象日

- **定義：** スクリプト実行時の日付（システム日時基準）
- **形式：** YYYY/MM/DD
- **例：** 2026/01/11

#### 4.1.2 Googleカレンダーから取得

**取得条件：**
- カレンダーIDはConfigシートから読み込む
- 実行当日の0時00分～23時59分の予定を取得
- 終日イベントも含む
- 削除済みイベントは除外
- キャンセル済みイベントは除外（任意の参加者のステータスが「キャンセル」）

**表示形式：**
- 通常イベント：「・[予定タイトル] [開始時刻]-[終了時刻]」
  - 例：「・顧客訪問 10:00-11:00」
- 終日イベント：「・[予定タイトル]（終日）」
  - 例：「・出張（終日）」
- 予定が0件の場合：「・予定なし」
- 時刻の表示形式：HH:mm（24時間表記）

**取得処理の詳細：**
1. Configシートから`CALENDAR_ID`を取得
2. Calendar APIの`Events.list()`を使用
3. 取得期間：実行当日の00:00:00～23:59:59（JST基準）
4. タイムゾーン：Asia/Tokyo（JST）
5. ソート：開始時刻の昇順

#### 4.1.3 営業KPIシートから取得

**取得条件：**
- KPIシートから実行当日の日付に一致する行を検索
- 日付列（A列）が実行当日と一致する行を取得
- 日付の比較は日付部分のみ（時刻は無視）

**取得データ：**
- 訪問数（B列）：必須、0以上の整数
- 架電数（C列）：任意、0以上の整数（MVPでは表示に使用しない）
- 商談数（D列）：任意、0以上の整数（MVPでは表示に使用しない）

**データ処理規則：**
- 訪問数が空（未入力）の場合：0として扱う
- 訪問数が負の値の場合：エラー（バリデーションエラー）
- 訪問数が数値以外の場合：エラー（バリデーションエラー）

**表示形式：**
- 「・訪問数：[数値]件」
- 例：「・訪問数：2件」

**エラーケース：**
- 該当日の行が存在しない：エラーメッセージ表示、処理中断
- 日付列が空：エラーメッセージ表示、処理中断
- 日付列が日付形式でない：エラーメッセージ表示、処理中断

### 4.2 コメント欄（手入力・編集可）

**入力項目：**
1. 上手く行ったこと
2. 上手く行かなかったこと
3. 明日やること

**制約：**
- 必須項目：なし（すべて空欄でも送信可能）
- 文字数制限：なし（実運用で必要に応じて調整、推奨：各項目500文字以内）
- 改行：可（複数行入力可能）
- データ型：文字列
- 特殊文字：すべて許可（Slack送信時のエスケープは考慮する）

**編集方法：**
- スプレッドシートのセルを直接編集
- 送信済みフラグがTRUEの場合も編集可能（ただし送信は不可）

### 4.3 Slack送信

#### 4.3.1 送信処理

**実行方法：**
- スプレッドシートのカスタムメニューから「日報送信」を選択
- または、カスタムボタンをクリック

**送信処理フロー：**
1. 実行当日の日付を取得
2. DailyReport_Draftシートから該当日の行を検索
3. 送信済みフラグをチェック（TRUEの場合はエラー）
4. Slack投稿本文を生成（`formatDailyReportText()`関数）
5. ConfigシートからWebhook URLとチャンネル名を取得
6. Slack Incoming Webhook APIにPOSTリクエストを送信
7. 送信成功時：
   - 送信済みフラグをTRUEに更新
   - 送信日時を現在日時に更新
8. 送信失敗時：
   - エラーメッセージを表示
   - 送信済みフラグは更新しない

#### 4.3.2 二重送信防止

**仕組み：**
- DailyReport_Draftシートの「送信済み」列（H列）で管理
- 送信前に送信済みフラグをチェック
- TRUEの場合は送信をブロックし、エラーメッセージを表示

**再送信方法：**
- 送信済みフラグを手動でFALSEに変更すれば再送信可能
- 過去日の日報も同様に再送信可能

#### 4.3.3 Slack投稿本文の生成

**生成タイミング：**
- 送信実行時に動的に生成（DailyReport_Draftシートの「Slack投稿本文」列は参考用）
- 送信時点の最新データを使用

**生成処理：**
- `formatDailyReportText(rowData)`関数で生成
- 手入力欄の内容を最新の状態で取得
- フォーマット規則に従って結合

## 5. データ定義

### 5.1 スプレッドシート構成

#### 5.1.1 シート①：KPI

**シート名：** `KPI`（固定、大文字小文字を区別）

**列構成：**

| 列 | 列名 | 型 | 必須 | 制約 | 説明 | 例 |
|----|------|-----|------|------|------|-----|
| A | 日付 | 日付 | YES | YYYY/MM/DD形式、重複不可 | 対象日 | 2026/01/11 |
| B | 訪問数 | 数値 | YES | 0以上の整数 | 営業訪問件数 | 2 |
| C | 架電数 | 数値 | NO | 0以上の整数 | 電話件数（MVPでは未使用） | 5 |
| D | 商談数 | 数値 | NO | 0以上の整数 | 商談件数（MVPでは未使用） | 1 |

**データ規則：**
- 1行目はヘッダー行（固定）
- 2行目以降にデータ
- 日付は重複不可（1日1行）
- 数値は整数のみ（小数点は扱わない）
- 日付列が空の行は無視（データ終端として扱う）

**サンプルデータ：**

| 日付 | 訪問数 | 架電数 | 商談数 |
|------|--------|--------|--------|
| 2026/01/11 | 2 | 5 | 1 |
| 2026/01/12 | 3 | 7 | 2 |

#### 5.1.2 シート②：DailyReport_Draft

**シート名：** `DailyReport_Draft`（固定、大文字小文字を区別）

**列構成：**

| 列 | 列名 | 型 | 必須 | 制約 | 説明 | 例 |
|----|------|-----|------|------|------|-----|
| A | 日付 | 日付 | YES | YYYY/MM/DD形式、重複不可 | 対象日 | 2026/01/11 |
| B | スケジュール本文 | 文字列 | YES | - | 自動生成（カレンダーから） | 「・顧客訪問 10:00-11:00\n・会議 14:00-15:00」 |
| C | KPI本文 | 文字列 | YES | - | 自動生成（KPIシートから） | 「・訪問数：2件」 |
| D | 上手く行ったこと | 文字列 | NO | - | 手入力 | 「新規顧客と商談が成立した」 |
| E | 上手く行かなかったこと | 文字列 | NO | - | 手入力 | 「訪問先が不在だった」 |
| F | 明日やること | 文字列 | NO | - | 手入力 | 「提案書を作成する」 |
| G | Slack投稿本文 | 文字列 | YES | - | 自動生成（参考用、編集不可推奨） | （フォーマット参照） |
| H | 送信済み | ブール値 | YES | TRUE/FALSE | 送信フラグ（デフォルト：FALSE） | FALSE |
| I | 送信日時 | 日時 | NO | - | 送信成功時の日時 | 2026/01/11 18:30:00 |

**データ規則：**
- 1行目はヘッダー行（固定）
- 2行目以降にデータ
- 日付は重複不可（1日1行）
- 同日の行が既に存在する場合：上書き（既存行を更新）
- 送信済みがTRUEの場合、手動編集は可能だが送信は不可
- Slack投稿本文（G列）は自動生成（参考用、手動編集は非推奨）

**サンプルデータ：**

| 日付 | スケジュール本文 | KPI本文 | 上手く行ったこと | 上手く行かなかったこと | 明日やること | 送信済み | 送信日時 |
|------|------------------|---------|------------------|------------------------|--------------|----------|----------|
| 2026/01/11 | 「・顧客訪問 10:00-11:00\n・会議 14:00-15:00」 | 「・訪問数：2件」 | 「新規顧客と商談が成立した」 | 「訪問先が不在だった」 | 「提案書を作成する」 | FALSE | - |

#### 5.1.3 シート③：Config

**シート名：** `Config`（固定、大文字小文字を区別）

**列構成：**

| 列 | 列名 | 型 | 必須 | 制約 | 説明 | 例 |
|----|------|-----|------|------|------|-----|
| A | 設定項目 | 文字列 | YES | - | 設定項目名（キー） | CALENDAR_ID |
| B | 設定値 | 文字列 | YES | - | 設定値（値） | primary |

**データ規則：**
- 1行目はヘッダー行（固定）
- 2行目以降に設定項目と設定値を記入
- 設定項目名は大文字小文字を区別
- 設定項目名は重複不可（1つのキーに1つの値）

**必須設定項目：**

| 設定項目 | 説明 | フォーマット | 取得方法 | 例 |
|----------|------|--------------|----------|-----|
| CALENDAR_ID | GoogleカレンダーID | 文字列 | Googleカレンダー設定画面 > カレンダーの統合 > カレンダーID | `primary` または `xxx@group.calendar.google.com` |
| SLACK_WEBHOOK_URL | Slack Incoming Webhook URL | URL（https://） | Slackアプリ設定 > Incoming Webhooks > Webhook URLを追加 | `(YOUR_SLACK_WEBHOOK_URL)` |
| SLACK_CHANNEL | 投稿先チャンネル名 | 文字列（#から始まる） | Slackチャンネル名 | `#daily-report` |

**Configシートのサンプルデータ：**

| 設定項目 | 設定値 |
|----------|--------|
| CALENDAR_ID | primary |
| SLACK_WEBHOOK_URL | (YOUR_SLACK_WEBHOOK_URL) |
| SLACK_CHANNEL | #daily-report |

### 5.2 日報フォーマット（Slack投稿本文）

#### 5.2.1 フォーマット定義

```
【日報】YYYY/MM/DD

■ 本日のスケジュール
・予定A
・予定B

■ KPI実績
・訪問数：2件

■ 上手く行ったこと
（手入力内容）

■ 上手く行かなかったこと
（手入力内容）

■ 明日やること
（手入力内容）
```

#### 5.2.2 フォーマット規則

- **日付：** YYYY/MM/DD 形式（例：2026/01/11）
- **予定が0件の場合：** 「・予定なし」と表示
- **手入力欄が空欄の場合：** そのセクションは「（未記入）」と表示
- **改行：** そのまま反映（手入力欄の改行も保持）
- **文字エンコーディング：** UTF-8
- **特殊文字：** Slackのメッセージ形式に合わせてエスケープ（<, >, &など）

#### 5.2.3 フォーマット例

**例1：すべての項目が入力されている場合**

```
【日報】2026/01/11

■ 本日のスケジュール
・顧客訪問 10:00-11:00
・会議 14:00-15:00

■ KPI実績
・訪問数：2件

■ 上手く行ったこと
新規顧客と商談が成立した

■ 上手く行かなかったこと
訪問先が不在だった

■ 明日やること
提案書を作成する
```

**例2：予定が0件の場合**

```
【日報】2026/01/11

■ 本日のスケジュール
・予定なし

■ KPI実績
・訪問数：2件

■ 上手く行ったこと
（未記入）

■ 上手く行かなかったこと
（未記入）

■ 明日やること
（未記入）
```

**例3：手入力欄が空欄の場合**

```
【日報】2026/01/11

■ 本日のスケジュール
・顧客訪問 10:00-11:00

■ KPI実績
・訪問数：2件

■ 上手く行ったこと
（未記入）

■ 上手く行かなかったこと
（未記入）

■ 明日やること
（未記入）
```

## 6. システム構成・アーキテクチャ

### 6.1 システム構成図

```
┌─────────────────────────────────────────────────────────────┐
│                      ユーザー（営業担当者）                    │
└───────────────────────┬─────────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────────┐
│              Google スプレッドシート                          │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │  KPIシート    │  │DailyReport_  │  │ Configシート  │     │
│  │              │  │  Draftシート  │  │              │     │
│  │ 日付、訪問数等│  │ 日報下書き    │  │ 設定値        │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
│                                                              │
│  ┌──────────────────────────────────────────────────────┐  │
│  │      Google Apps Script (GAS)                        │  │
│  │  ┌────────────────┐  ┌────────────────┐            │  │
│  │  │ 日報生成機能    │  │ Slack送信機能   │            │  │
│  │  └────────────────┘  └────────────────┘            │  │
│  └──────────────────────────────────────────────────────┘  │
└───────────────────────┬─────────────────────────────────────┘
                        │
        ┌───────────────┴───────────────┐
        │                               │
        ▼                               ▼
┌───────────────┐              ┌───────────────┐
│ Google Calendar│              │  Slack API    │
│   (API)        │              │  (Webhook)    │
│                │              │               │
│ 予定データ取得  │              │ 日報投稿      │
└───────────────┘              └───────────────┘
```

### 6.2 データフロー図

```
【日報生成時のデータフロー】

Configシート
  │ CALENDAR_ID, SLACK_WEBHOOK_URL, SLACK_CHANNEL
  ▼
GASスクリプト
  │
  ├─→ Calendar API ←─ Google Calendar（予定データ）
  │     │
  │     └─→ スケジュール本文（文字列）
  │
  ├─→ KPIシート（日付で検索）
  │     │
  │     └─→ KPI本文（文字列）
  │
  └─→ DailyReport_Draftシート（書き込み）
        │ 日付、スケジュール本文、KPI本文、送信済み=FALSE

【Slack送信時のデータフロー】

DailyReport_Draftシート（読み込み）
  │ 日付、スケジュール本文、KPI本文、手入力欄、送信済みフラグ
  ▼
GASスクリプト
  │
  ├─→ Slack投稿本文生成（フォーマット結合）
  │
  ├─→ Configシート（Webhook URL、チャンネル名取得）
  │
  └─→ Slack Webhook API（POST リクエスト）
        │
        ├─→ 送信成功
        │     │
        │     └─→ DailyReport_Draftシート更新
        │           送信済み=TRUE、送信日時=現在日時
        │
        └─→ 送信失敗
              │
              └─→ エラーメッセージ表示（送信済みフラグは更新しない）
```

### 6.3 処理フロー詳細（擬似コード）

```
【generateDailyReport()関数の処理フロー】

1. 今日の日付を取得（YYYY/MM/DD形式）
2. Configシートから設定値を取得
   - CALENDAR_ID取得 → エラー時：処理中断
   - SLACK_WEBHOOK_URL取得 → エラー時：処理中断（送信時のみ必要）
   - SLACK_CHANNEL取得 → エラー時：処理中断（送信時のみ必要）
3. カレンダーから予定を取得
   - getCalendarEvents(今日の日付)
   - エラー時：エラーメッセージ表示、処理中断
4. スケジュール本文をフォーマット
   - formatScheduleText(イベント配列)
5. KPIシートからデータを取得
   - getKPIData(今日の日付)
   - エラー時：エラーメッセージ表示、処理中断
6. KPI本文をフォーマット
   - formatKPIText(KPIデータ)
7. DailyReport_Draftシートを取得
8. 該当日の行を検索
   - findRowByDate(シート, 今日の日付, 0列目)
9. 行が存在する場合
   - 既存行を上書き
10. 行が存在しない場合
    - 新規行を追加
11. データを書き込み
    - 日付、スケジュール本文、KPI本文、送信済み=FALSE
12. 処理完了

【sendToSlack()関数の処理フロー】

1. 今日の日付を取得（YYYY/MM/DD形式）
2. Configシートから設定値を取得
   - SLACK_WEBHOOK_URL取得 → エラー時：処理中断
   - SLACK_CHANNEL取得 → エラー時：処理中断
3. DailyReport_Draftシートを取得
4. 該当日の行を検索
   - findRowByDate(シート, 今日の日付, 0列目)
   - 見つからない場合：エラーメッセージ表示、処理中断
5. 送信済みフラグをチェック
   - TRUEの場合：エラーメッセージ表示、処理中断
6. 行データを取得
   - 日付、スケジュール本文、KPI本文、手入力欄3項目
7. Slack投稿本文を生成
   - formatDailyReportText(行データ)
8. Slackに送信
   - sendSlackMessage(Webhook URL, チャンネル名, 投稿本文)
   - エラー時：エラーメッセージ表示、処理中断
9. 送信成功時
   - 送信済みフラグをTRUEに更新
   - 送信日時を現在日時に更新
10. 処理完了
```

### 6.4 依存関係

| コンポーネント | 依存先 | 依存内容 |
|---------------|--------|----------|
| GASスクリプト | Googleスプレッドシート | データの読み書き |
| GASスクリプト | Google Calendar API | 予定データの取得 |
| GASスクリプト | Slack Webhook API | メッセージ送信 |
| 日報生成機能 | Configシート | 設定値の読み込み |
| 日報生成機能 | KPIシート | KPIデータの読み込み |
| 日報生成機能 | Calendar API | 予定データの取得 |
| Slack送信機能 | Configシート | Webhook URL、チャンネル名 |
| Slack送信機能 | DailyReport_Draftシート | 日報データの読み込み・更新 |

## 7. UI設計・操作フロー

### 7.1 スプレッドシートの画面構成

#### 7.1.1 シート構成

- **KPIシート：** データ入力用
- **DailyReport_Draftシート：** 日報下書き表示・編集用
- **Configシート：** 設定管理用

#### 7.1.2 画面レイアウト詳細

**KPIシートのレイアウト：**

```
┌──────────┬──────────┬──────────┬──────────┐
│    A     │    B     │    C     │    D     │
├──────────┼──────────┼──────────┼──────────┤
│   日付   │  訪問数  │  架電数  │  商談数  │ ← 1行目：ヘッダー
├──────────┼──────────┼──────────┼──────────┤
│2026/01/11│    2     │    5     │    1     │ ← 2行目：データ
├──────────┼──────────┼──────────┼──────────┤
│2026/01/12│    3     │    7     │    2     │ ← 3行目：データ
└──────────┴──────────┴──────────┴──────────┘
```

**DailyReport_Draftシートのレイアウト：**

```
┌──────────┬──────────┬──────────┬──────────┬──────────┬──────────┬──────────┬──────────┬──────────┐
│    A     │    B     │    C     │    D     │    E     │    F     │    G     │    H     │    I     │
├──────────┼──────────┼──────────┼──────────┼──────────┼──────────┼──────────┼──────────┼──────────┤
│   日付   │スケジュール│ KPI本文 │上手く行った│上手く行かな│明日やること│Slack投稿│送信済み│送信日時│
│          │   本文   │          │   こと    │かったこと │          │   本文  │        │        │ ← 1行目：ヘッダー
├──────────┼──────────┼──────────┼──────────┼──────────┼──────────┼──────────┼──────────┼──────────┤
│2026/01/11│・顧客訪問 │・訪問数：│新規顧客と│訪問先が  │提案書を  │（自動生成│ FALSE  │        │ ← 2行目：データ
│          │10:00-11:00│2件      │商談が成立│不在だった│作成する  │された本文）│        │        │
│          │・会議    │          │          │          │          │          │        │        │
│          │14:00-15:00│          │          │          │          │          │        │        │
└──────────┴──────────┴──────────┴──────────┴──────────┴──────────┴──────────┴──────────┴──────────┘
```

**Configシートのレイアウト：**

```
┌──────────┬──────────────────────────────────────┐
│    A     │              B                        │
├──────────┼──────────────────────────────────────┤
│ 設定項目 │           設定値                      │ ← 1行目：ヘッダー
├──────────┼──────────────────────────────────────┤
│CALENDAR_ID│          primary                     │ ← 2行目：設定値
├──────────┼──────────────────────────────────────┤
│SLACK_    │(YOUR_SLACK_WEBHOOK_URL)              │ ← 3行目：設定値
│WEBHOOK_URL│                                      │
├──────────┼──────────────────────────────────────┤
│SLACK_    │          #daily-report               │ ← 4行目：設定値
│CHANNEL   │                                      │
└──────────┴──────────────────────────────────────┘
```

#### 7.1.3 カスタムメニュー

スプレッドシートを開いた際に、以下のメニューが追加される：

```
[ファイル] [編集] [表示] ... [日報システム] ← 新しいメニュー
                                ├─ 日報生成
                                └─ 日報送信
```

**メニュー追加タイミング：**
- スプレッドシートを開いた際（`onOpen()`関数で自動追加）

#### 7.1.4 カスタムボタン（オプション）

DailyReport_Draftシートに以下のボタンを配置可能：

- **「日報生成」ボタン：** `generateDailyReport()`関数を実行
- **「日報送信」ボタン：** `sendToSlack()`関数を実行

**ボタンの配置：**
- シート上部（1行目または2行目）に配置
- ボタンのサイズ・色は任意

### 7.2 操作フロー図

```
【日報生成フロー】
開始
  ↓
スプレッドシートを開く
  ↓
メニューから「日報生成」を選択
  ↓
Configシートから設定を読み込む
  ↓
カレンダーから当日の予定を取得
  ↓
KPIシートから当日のデータを取得
  ↓
DailyReport_Draftシートに下書きを生成
  ↓
ユーザーが手入力欄を編集（任意）
  ↓
メニューから「日報送信」を選択
  ↓
送信済みフラグをチェック
  ↓
Slack投稿本文を生成
  ↓
Slackに送信
  ↓
送信済みフラグをTRUEに更新
  ↓
送信日時を記録
  ↓
完了
```

## 8. API仕様・インターフェース

### 7.1 Google Calendar API

#### 7.1.1 使用API

- **API名：** Google Calendar API
- **メソッド：** `Events.list()`
- **認証：** OAuth 2.0（GASが自動処理）

#### 7.1.2 リクエストパラメータ

| パラメータ | 型 | 必須 | 説明 | 値 |
|------------|-----|------|------|-----|
| calendarId | string | YES | カレンダーID | Configシートから取得 |
| timeMin | datetime | YES | 取得開始日時 | 実行当日の00:00:00（JST） |
| timeMax | datetime | YES | 取得終了日時 | 実行当日の23:59:59（JST） |
| timeZone | string | NO | タイムゾーン | Asia/Tokyo |
| singleEvents | boolean | NO | 繰り返しイベントの展開 | true |
| orderBy | string | NO | ソート順 | startTime |
| maxResults | integer | NO | 最大取得件数 | 250（デフォルト） |

#### 7.1.3 レスポンス処理

- イベントリストから必要な情報を抽出：
  - `summary`（予定タイトル）
  - `start.dateTime`（開始時刻）
  - `start.date`（終日イベントの日付）
  - `end.dateTime`（終了時刻）
  - `end.date`（終日イベントの終了日）

#### 7.1.4 エラーハンドリング

- カレンダーID無効：`404 Not Found` → エラーメッセージ表示
- 権限なし：`403 Forbidden` → エラーメッセージ表示
- API制限：`429 Too Many Requests` → エラーメッセージ表示

### 7.2 Slack Incoming Webhook API

#### 7.2.1 使用API

- **API名：** Slack Incoming Webhooks
- **メソッド：** HTTP POST
- **認証：** Webhook URL（URLに含まれる）

#### 7.2.2 リクエスト仕様

- **URL：** Configシートから取得した`SLACK_WEBHOOK_URL`
- **メソッド：** POST
- **Content-Type：** `application/json`
- **ボディ：** JSON形式

#### 7.2.3 リクエストボディ形式

```json
{
  "channel": "#daily-report",
  "text": "【日報】2026/01/11\n\n■ 本日のスケジュール\n..."
}
```

**パラメータ：**

| パラメータ | 型 | 必須 | 説明 | 値 |
|------------|-----|------|------|-----|
| channel | string | NO | チャンネル名 | Configシートから取得（例：#daily-report） |
| text | string | YES | 投稿本文 | フォーマット規則に従って生成 |

#### 7.2.4 レスポンス処理

- **成功時：** HTTP 200 OK → 送信済みフラグをTRUEに更新
- **失敗時：** HTTP 4xx/5xx → エラーメッセージ表示、送信済みフラグは更新しない

#### 7.2.5 エラーハンドリング

- Webhook URL無効：`404 Not Found` → エラーメッセージ表示
- チャンネル名無効：`404 Not Found` → エラーメッセージ表示（実際には投稿される場合あり）
- ネットワークエラー：接続タイムアウト → エラーメッセージ表示

## 9. 例外ケースとエラーハンドリング

### 9.1 カレンダー関連

| ケース | HTTPステータス/エラー | 動作 | エラーメッセージ |
|--------|----------------------|------|------------------|
| カレンダーIDが無効 | 404 Not Found | エラーメッセージ表示、処理中断 | 「エラー：カレンダーIDが無効です。ConfigシートのCALENDAR_IDを確認してください。」 |
| カレンダーへのアクセス権限なし | 403 Forbidden | エラーメッセージ表示、処理中断 | 「エラー：カレンダーへのアクセス権限がありません。カレンダーの共有設定を確認してください。」 |
| 予定が0件 | - | 「・予定なし」として処理継続 | - |
| API制限エラー | 429 Too Many Requests | エラーメッセージ表示、処理中断 | 「エラー：APIの利用制限に達しました。しばらく時間をおいてから再度お試しください。」 |
| カレンダーIDがConfigに存在しない | - | エラーメッセージ表示、処理中断 | 「エラー：ConfigシートにCALENDAR_IDが設定されていません。」 |

### 9.2 KPIシート関連

| ケース | 動作 | エラーメッセージ |
|--------|------|------------------|
| 該当日の行が存在しない | エラーメッセージ表示、処理中断 | 「エラー：KPIシートに本日（YYYY/MM/DD）のデータが存在しません。KPIシートにデータを入力してください。」 |
| 日付列が空 | エラーメッセージ表示、処理中断 | 「エラー：KPIシートの日付列に空の値があります。日付を入力してください。」 |
| 日付列が日付形式でない | エラーメッセージ表示、処理中断 | 「エラー：KPIシートの日付列の形式が正しくありません。YYYY/MM/DD形式で入力してください。」 |
| 訪問数が空（未入力） | 0として扱う（エラーなし） | - |
| 訪問数が負の値 | エラーメッセージ表示、処理中断 | 「エラー：KPIシートの訪問数が負の値です。0以上の整数を入力してください。」 |
| 訪問数が数値以外 | エラーメッセージ表示、処理中断 | 「エラー：KPIシートの訪問数が数値ではありません。整数を入力してください。」 |
| KPIシートが存在しない | エラーメッセージ表示、処理中断 | 「エラー：KPIシートが見つかりません。シート名を確認してください。」 |

### 9.3 送信関連

| ケース | HTTPステータス/エラー | 動作 | エラーメッセージ |
|--------|----------------------|------|------------------|
| 送信済みフラグがTRUE | - | エラーメッセージ表示、送信ブロック | 「エラー：この日報は既に送信済みです。再送信する場合は、送信済みフラグをFALSEに変更してください。」 |
| Webhook URLが無効 | 404 Not Found | エラーメッセージ表示、処理中断 | 「エラー：Slack Webhook URLが無効です。ConfigシートのSLACK_WEBHOOK_URLを確認してください。」 |
| チャンネル名が無効 | - | エラーメッセージ表示、処理中断 | 「エラー：Slackチャンネル名が無効です。ConfigシートのSLACK_CHANNELを確認してください。」 |
| Slack送信失敗（ネットワークエラー等） | タイムアウト/接続エラー | エラーメッセージ表示、送信済みフラグは更新しない | 「エラー：Slackへの送信に失敗しました。ネットワーク接続を確認してください。」 |
| 手入力欄が全て空 | - | 送信可能（制約なし） | - |
| 該当日の日報が存在しない | - | エラーメッセージ表示、処理中断 | 「エラー：本日（YYYY/MM/DD）の日報が存在しません。先に「日報生成」を実行してください。」 |
| Webhook URLがConfigに存在しない | - | エラーメッセージ表示、処理中断 | 「エラー：ConfigシートにSLACK_WEBHOOK_URLが設定されていません。」 |
| チャンネル名がConfigに存在しない | - | エラーメッセージ表示、処理中断 | 「エラー：ConfigシートにSLACK_CHANNELが設定されていません。」 |

### 9.4 Configシート関連

| ケース | 動作 | エラーメッセージ |
|--------|------|------------------|
| Configシートが存在しない | エラーメッセージ表示、処理中断 | 「エラー：Configシートが見つかりません。シート名を確認してください。」 |
| 必須設定項目が不足 | エラーメッセージ表示、処理中断 | 「エラー：Configシートに必須設定項目（[項目名]）が設定されていません。」 |
| 設定項目の値が空 | エラーメッセージ表示、処理中断 | 「エラー：Configシートの設定項目（[項目名]）の値が空です。」 |

### 9.5 その他

| ケース | 動作 | エラーメッセージ |
|--------|------|------------------|
| 同日の日報が既に存在 | 上書き（既存行を更新、エラーなし） | - |
| 過去日の日報を編集・再送信 | 可能（送信済みフラグをFALSEに戻せば再送信可能） | - |
| DailyReport_Draftシートが存在しない | エラーメッセージ表示、処理中断 | 「エラー：DailyReport_Draftシートが見つかりません。シート名を確認してください。」 |

### 9.6 エラーメッセージ一覧（まとめ）

| エラーコード | エラーメッセージ | 発生箇所 |
|--------------|------------------|----------|
| ERR_CALENDAR_ID_INVALID | エラー：カレンダーIDが無効です。ConfigシートのCALENDAR_IDを確認してください。 | カレンダー取得時 |
| ERR_CALENDAR_PERMISSION | エラー：カレンダーへのアクセス権限がありません。カレンダーの共有設定を確認してください。 | カレンダー取得時 |
| ERR_CALENDAR_API_LIMIT | エラー：APIの利用制限に達しました。しばらく時間をおいてから再度お試しください。 | カレンダー取得時 |
| ERR_CALENDAR_ID_MISSING | エラー：ConfigシートにCALENDAR_IDが設定されていません。 | 設定読み込み時 |
| ERR_KPI_DATA_NOT_FOUND | エラー：KPIシートに本日（YYYY/MM/DD）のデータが存在しません。KPIシートにデータを入力してください。 | KPI取得時 |
| ERR_KPI_DATE_EMPTY | エラー：KPIシートの日付列に空の値があります。日付を入力してください。 | KPI取得時 |
| ERR_KPI_DATE_FORMAT | エラー：KPIシートの日付列の形式が正しくありません。YYYY/MM/DD形式で入力してください。 | KPI取得時 |
| ERR_KPI_VISIT_NEGATIVE | エラー：KPIシートの訪問数が負の値です。0以上の整数を入力してください。 | KPI取得時 |
| ERR_KPI_VISIT_NOT_NUMBER | エラー：KPIシートの訪問数が数値ではありません。整数を入力してください。 | KPI取得時 |
| ERR_KPI_SHEET_NOT_FOUND | エラー：KPIシートが見つかりません。シート名を確認してください。 | KPI取得時 |
| ERR_ALREADY_SENT | エラー：この日報は既に送信済みです。再送信する場合は、送信済みフラグをFALSEに変更してください。 | 送信時 |
| ERR_WEBHOOK_URL_INVALID | エラー：Slack Webhook URLが無効です。ConfigシートのSLACK_WEBHOOK_URLを確認してください。 | 送信時 |
| ERR_SLACK_CHANNEL_INVALID | エラー：Slackチャンネル名が無効です。ConfigシートのSLACK_CHANNELを確認してください。 | 送信時 |
| ERR_SLACK_SEND_FAILED | エラー：Slackへの送信に失敗しました。ネットワーク接続を確認してください。 | 送信時 |
| ERR_REPORT_NOT_FOUND | エラー：本日（YYYY/MM/DD）の日報が存在しません。先に「日報生成」を実行してください。 | 送信時 |
| ERR_WEBHOOK_URL_MISSING | エラー：ConfigシートにSLACK_WEBHOOK_URLが設定されていません。 | 設定読み込み時 |
| ERR_SLACK_CHANNEL_MISSING | エラー：ConfigシートにSLACK_CHANNELが設定されていません。 | 設定読み込み時 |
| ERR_CONFIG_SHEET_NOT_FOUND | エラー：Configシートが見つかりません。シート名を確認してください。 | 設定読み込み時 |
| ERR_CONFIG_ITEM_MISSING | エラー：Configシートに必須設定項目（[項目名]）が設定されていません。 | 設定読み込み時 |
| ERR_CONFIG_VALUE_EMPTY | エラー：Configシートの設定項目（[項目名]）の値が空です。 | 設定読み込み時 |
| ERR_DRAFT_SHEET_NOT_FOUND | エラー：DailyReport_Draftシートが見つかりません。シート名を確認してください。 | 日報生成時 |

## 10. 機能スコープ

### 10.1 MVPで実装する機能（やること）

1. **日報下書きの自動生成**
   - 当日のカレンダー予定取得
   - 当日のKPI数値取得
   - テキスト形式での自動生成
   - 同日の日報が既に存在する場合の上書き処理

2. **コメント欄（手入力・編集可）**
   - 3項目の手入力フィールド
   - 空欄でも送信可能

3. **Slack送信**
   - メニューまたはボタン操作
   - 二重送信防止（送信済みフラグ管理）
   - 送信日時の記録

4. **設定管理**
   - Configシートからの設定読み込み
   - 必須設定項目のバリデーション

5. **エラーハンドリング**
   - すべてのエラーケースに対する適切なエラーメッセージ表示
   - 処理中断時の適切な処理

### 10.2 MVPではやらない（後回し・Won't）

1. AIによるコメント自動生成
2. 週報・月報の自動生成
3. 個人別テンプレート管理
4. KPIの細分化（架電数・商談数の表示は省略可）
5. カレンダーの高度な分類（カテゴリ分け等）
6. 日報の履歴管理・検索機能
7. 複数カレンダーの統合
8. スケジュールの詳細情報（場所・説明等）の表示
9. 画像・ファイルの添付
10. 日報のテンプレートカスタマイズ
11. 日報のエクスポート機能（PDF、Excel等）
12. 日報の印刷機能
13. 複数ユーザー対応（1スプレッドシート1ユーザーの前提）
14. 日報の承認ワークフロー
15. 日報のコメント機能

## 11. 受け入れ条件

1. **カレンダー連携**
   - 実行当日のカレンダー予定が「本日のスケジュール」に正しく反映される
   - 予定が0件の場合、「・予定なし」と表示される
   - 終日イベントが正しく表示される（「（終日）」表記）
   - 予定のソート順が開始時刻の昇順になっている

2. **KPI連携**
   - 実行当日のKPI数値が「KPI実績」に正しく反映される
   - 数値が空の場合は0として扱われる
   - 負の値が入力された場合はエラーが表示される

3. **自動生成**
   - スプレッドシート上でスクリプトを実行すると、DailyReport_Draftシートに下書きが生成される
   - 同日の行が既に存在する場合は上書きされる（エラーにならない）
   - スケジュール本文とKPI本文が正しく生成される

4. **手入力**
   - 3項目の手入力欄が編集可能である
   - 空欄でも保存・送信可能である
   - 改行が正しく反映される

5. **Slack投稿本文の自動結合**
   - 手入力欄を含めた全項目が正しいフォーマットで結合される
   - 空欄の場合は「（未記入）」と表示される
   - 日付が正しい形式（YYYY/MM/DD）で表示される

6. **送信機能**
   - メニューまたはボタン操作でSlackに送信できる
   - 送信成功時に送信済みフラグがTRUEに更新される
   - 送信成功時に送信日時が記録される
   - Slackに正しいチャンネルに正しい内容が投稿される

7. **二重送信防止**
   - 送信済みフラグがTRUEの場合、送信がブロックされる
   - エラーメッセージが表示される
   - 送信済みフラグをFALSEに戻せば再送信可能

8. **エラーハンドリング**
   - カレンダーID無効時、適切なエラーメッセージが表示される
   - KPIシートに該当日の行がない場合、適切なエラーメッセージが表示される
   - Webhook URL無効時、適切なエラーメッセージが表示される
   - すべてのエラーケースで処理が適切に中断される

9. **設定管理**
   - ConfigシートからカレンダーID、Webhook URL、チャンネル名を読み込める
   - 必須設定項目が不足している場合、適切なエラーメッセージが表示される

10. **過去日の編集・再送信**
    - 過去日の日報を編集できる
    - 送信済みフラグをFALSEに戻すことで再送信できる

## 12. NG例（動作上のNG）

1. カレンダー予定が取得できないのにエラーなく処理が継続する
2. KPIシートに該当日の行がないのにエラーなく処理が継続する
3. 送信済みフラグがTRUEのまま送信できてしまう
4. 空の日報（手入力欄が全て空）が送信できない
5. 同日の日報を生成しようとしてエラーになる（上書きされるべき）
6. 送信成功後に送信済みフラグが更新されない
7. Configシートの設定が読み込めないのにエラーなく処理が継続する
8. Slack送信失敗時に送信済みフラグがTRUEになってしまう
9. エラーメッセージが分かりにくい（技術的なメッセージのみ）
10. 終日イベントが通常イベントと同じ形式で表示される
11. 予定のソート順が不定（開始時刻の昇順でない）
12. 手入力欄の改行が正しく反映されない

## 13. 実装方針

### 12.1 Google Apps Script（GAS）の構成

#### 12.1.1 関数構成

**メイン関数：**
- `generateDailyReport()`: 日報下書き生成のメイン関数
- `sendToSlack()`: Slack送信のメイン関数（引数：日付）
- `onOpen()`: スプレッドシートを開いた際にメニューを追加

**カレンダー関連：**
- `getCalendarEvents(date)`: カレンダーから予定を取得（戻り値：イベント配列）
- `formatScheduleText(events)`: スケジュール本文をフォーマット（戻り値：文字列）

**KPI関連：**
- `getKPIData(date)`: KPIシートから数値を取得（戻り値：オブジェクト）
- `formatKPIText(kpiData)`: KPI本文をフォーマット（戻り値：文字列）

**Slack関連：**
- `formatDailyReportText(rowData)`: 日報本文をフォーマット（戻り値：文字列）
- `sendSlackMessage(webhookUrl, channel, text)`: Slackにメッセージを送信

**設定・ユーティリティ：**
- `getConfigValue(key)`: Configシートから設定値を取得（戻り値：文字列）
- `getTodayDateString()`: 今日の日付をYYYY/MM/DD形式で取得（戻り値：文字列）
- `findRowByDate(sheet, dateString, dateColumnIndex)`: 指定日付の行を検索（戻り値：行番号、見つからない場合は-1）
- `showError(message)`: エラーメッセージを表示（Browser.msgBox()を使用）

#### 12.1.2 定数定義

```javascript
// シート名
const SHEET_NAME_KPI = 'KPI';
const SHEET_NAME_DRAFT = 'DailyReport_Draft';
const SHEET_NAME_CONFIG = 'Config';

// 列インデックス（DailyReport_Draftシート）
const COL_DATE = 0;  // A列：日付
const COL_SCHEDULE = 1;  // B列：スケジュール本文
const COL_KPI = 2;  // C列：KPI本文
const COL_GOOD = 3;  // D列：上手く行ったこと
const COL_BAD = 4;  // E列：上手く行かなかったこと
const COL_TOMORROW = 5;  // F列：明日やること
const COL_SLACK_TEXT = 6;  // G列：Slack投稿本文
const COL_SENT = 7;  // H列：送信済み
const COL_SENT_DATETIME = 8;  // I列：送信日時

// Config設定項目名
const CONFIG_CALENDAR_ID = 'CALENDAR_ID';
const CONFIG_WEBHOOK_URL = 'SLACK_WEBHOOK_URL';
const CONFIG_CHANNEL = 'SLACK_CHANNEL';
```

#### 12.1.3 実行方法

- **方法1：** スプレッドシートのカスタムメニューから選択
- **方法2：** カスタムボタンをクリック（オプション）

### 12.2 スプレッドシートの初期設定手順

1. 新しいGoogleスプレッドシートを作成
2. シート①「KPI」を作成し、列ヘッダーを設定（A列：日付、B列：訪問数、C列：架電数、D列：商談数）
3. シート②「DailyReport_Draft」を作成し、列ヘッダーを設定（A列～I列）
4. シート③「Config」を作成し、設定項目と設定値を記入
5. テスト用のKPIデータを1行以上入力
6. GASスクリプトエディタを開き、スクリプトを貼り付け
7. スクリプトを保存
8. 初回実行時に権限を付与（カレンダーへのアクセス権限など）

## 14. テスト項目

### 13.1 正常系テスト

#### テストケース1：カレンダー予定あり、KPIデータあり、手入力あり

**前提条件：**
- カレンダーに当日の予定が2件以上存在
- KPIシートに当日のデータが入力されている
- 手入力欄にすべて入力されている

**テスト手順：**
1. メニューから「日報生成」を選択
2. DailyReport_Draftシートを確認
3. 手入力欄を確認（必要に応じて編集）
4. メニューから「日報送信」を選択
5. Slackで投稿を確認

**期待結果：**
- スケジュール本文に予定が正しく表示される
- KPI本文に訪問数が正しく表示される
- 手入力欄が正しく反映される
- Slackに正しい内容が投稿される
- 送信済みフラグがTRUEになる
- 送信日時が記録される

#### テストケース2：カレンダー予定なし、KPIデータあり、手入力あり

**前提条件：**
- カレンダーに当日の予定が0件
- KPIシートに当日のデータが入力されている
- 手入力欄にすべて入力されている

**テスト手順：**
1. メニューから「日報生成」を選択
2. DailyReport_Draftシートを確認
3. 手入力欄を確認（必要に応じて編集）
4. メニューから「日報送信」を選択
5. Slackで投稿を確認

**期待結果：**
- スケジュール本文に「・予定なし」と表示される
- その他の項目が正しく表示される
- Slackに正しい内容が投稿される

#### テストケース3：カレンダー予定あり、KPIデータあり、手入力空欄

**前提条件：**
- カレンダーに当日の予定が1件以上存在
- KPIシートに当日のデータが入力されている
- 手入力欄が空欄

**テスト手順：**
1. メニューから「日報生成」を選択
2. DailyReport_Draftシートを確認
3. 手入力欄を空欄のままにする
4. メニューから「日報送信」を選択
5. Slackで投稿を確認

**期待結果：**
- 手入力欄が空欄でも送信できる
- Slack投稿本文に「（未記入）」と表示される
- その他の項目が正しく表示される

#### テストケース4：過去日の日報編集・再送信

**前提条件：**
- 過去日の日報が存在し、送信済みフラグがTRUE

**テスト手順：**
1. DailyReport_Draftシートで過去日の行を確認
2. 手入力欄を編集
3. 送信済みフラグをFALSEに変更
4. メニューから「日報送信」を選択
5. Slackで投稿を確認

**期待結果：**
- 過去日の日報が編集できる
- 送信済みフラグをFALSEに変更すれば再送信できる
- 編集した内容が正しく反映される

#### テストケース5：同日の日報が既に存在する場合の上書き

**前提条件：**
- 当日の日報が既に存在

**テスト手順：**
1. メニューから「日報生成」を選択
2. DailyReport_Draftシートを確認

**期待結果：**
- エラーにならない
- 既存行が上書きされる（新しい行が追加されない）

### 13.2 異常系テスト

#### テストケース6：カレンダーID無効

**前提条件：**
- ConfigシートのCALENDAR_IDが無効な値

**テスト手順：**
1. ConfigシートのCALENDAR_IDを無効な値に変更
2. メニューから「日報生成」を選択

**期待結果：**
- エラーメッセージが表示される
- 処理が中断される
- DailyReport_Draftシートが更新されない

#### テストケース7：KPIシートに該当日の行なし

**前提条件：**
- KPIシートに当日のデータが存在しない

**テスト手順：**
1. KPIシートから当日の行を削除
2. メニューから「日報生成」を選択

**期待結果：**
- エラーメッセージが表示される
- 処理が中断される
- DailyReport_Draftシートが更新されない

#### テストケース8：送信済みフラグTRUE

**前提条件：**
- 当日の日報が存在し、送信済みフラグがTRUE

**テスト手順：**
1. メニューから「日報送信」を選択

**期待結果：**
- エラーメッセージが表示される
- 送信がブロックされる
- Slackに投稿されない

#### テストケース9：Webhook URL無効

**前提条件：**
- ConfigシートのSLACK_WEBHOOK_URLが無効な値

**テスト手順：**
1. ConfigシートのSLACK_WEBHOOK_URLを無効な値に変更
2. メニューから「日報送信」を選択

**期待結果：**
- エラーメッセージが表示される
- 処理が中断される
- 送信済みフラグが更新されない

#### テストケース10：Config設定項目不足

**前提条件：**
- Configシートから必須設定項目を削除

**テスト手順：**
1. ConfigシートからCALENDAR_IDを削除
2. メニューから「日報生成」を選択

**期待結果：**
- エラーメッセージが表示される
- 処理が中断される

## 15. 完了条件

以下のすべてが満たされた場合、MVP完成とする：

1. **動作確認**
   - テスト項目（正常系・異常系）をすべて実行し、期待通りの動作を確認
   - すべてのテストケースがパスする

2. **仕様適合**
   - 受け入れ条件10項目すべてをクリア
   - NG例が発生しない

3. **ドキュメント**
   - 使用方法の説明がREADMEまたはコメントに記載されている
   - 設定方法が明確に記載されている

4. **運用準備**
   - Configシートの設定方法が明確
   - エラーメッセージが分かりやすい
   - トラブルシューティングガイドが準備されている（オプション）

## 16. ログ・デバッグ方針

### 15.1 ログ出力

- **エラー発生時：** `Logger.log()`でエラー内容を記録
- **主要な処理開始・終了時：** ログを出力
  - 例：「日報生成開始：2026/01/11」
  - 例：「カレンダー予定取得完了：2件」
  - 例：「KPIデータ取得完了：訪問数=2」
  - 例：「Slack送信完了」

### 15.2 デバッグ方法

- GASスクリプトエディタの「実行」機能を使用
- `Logger.log()`の出力を「表示」>「ログ」で確認
- エラーメッセージは`Browser.msgBox()`で表示（ユーザー向け）

### 15.3 エラーメッセージ

- ユーザー向け：`Browser.msgBox()`で表示（分かりやすい日本語）
- 開発者向け：`Logger.log()`で記録（詳細な情報）

## 17. エラー方針

- **すべてのエラーは処理を中断し、エラーメッセージを表示**
- **エラーメッセージは原因が分かる内容とする**
- **部分的成功（例：カレンダー取得成功、送信失敗）は許可しない（すべて成功するか、すべて失敗するか）**
- **エラー発生時は、データの整合性を保つ（中途半端な状態でデータを更新しない）**

## 18. セキュリティ要件

### 17.1 認証・認可

- Googleアカウントによる認証（GASが自動処理）
- カレンダーへのアクセス権限は実行時にユーザーが承認
- Slack Webhook URLは機密情報として扱う（Configシートに保存）

### 17.2 データ保護

- スプレッドシートの共有設定は適切に管理（必要最小限のユーザーのみアクセス可能）
- ConfigシートのWebhook URLは機密情報（他のユーザーと共有しない）
- 日報データは個人情報を含む可能性があるため、適切に管理

### 17.3 アクセス制御

- スプレッドシートの編集権限は必要最小限のユーザーのみ
- カレンダーの共有設定は適切に管理

## 19. パフォーマンス要件・制限事項

### 18.1 処理時間

- 日報生成：5秒以内（カレンダー予定10件、KPIデータ1件を想定）
- Slack送信：3秒以内（ネットワーク状況に依存）

### 18.2 制限事項

- GASの実行時間制限：6分（無料版）
- GASの実行回数制限：1日あたり20,000回（無料版）
- Calendar APIの利用制限：1秒あたり250クエリ
- Slack Webhookの送信制限：1秒あたり1リクエスト（推奨）
- カレンダー予定の取得件数：最大250件（API制限）

### 18.3 最適化方針

- 必要最小限のデータのみ取得
- エラー発生時は早期に処理を中断
- ログ出力は必要最小限に

## 20. 運用・保守要件

### 19.1 初期設定手順

1. Googleスプレッドシートを作成
2. 3つのシート（KPI、DailyReport_Draft、Config）を作成
3. 列ヘッダーを設定
4. Configシートに設定値を記入
5. GASスクリプトを貼り付け
6. 初回実行時に権限を付与

### 19.2 日常運用

- 毎日、KPIシートに当日のデータを入力
- メニューから「日報生成」を実行
- 手入力欄を編集（任意）
- メニューから「日報送信」を実行

### 19.3 トラブルシューティング

**問題：カレンダー予定が取得できない**
- ConfigシートのCALENDAR_IDを確認
- カレンダーの共有設定を確認
- カレンダーIDが正しいか確認

**問題：KPIデータが取得できない**
- KPIシートに当日のデータが入力されているか確認
- 日付の形式が正しいか確認（YYYY/MM/DD）

**問題：Slack送信に失敗する**
- ConfigシートのSLACK_WEBHOOK_URLを確認
- Webhook URLが有効か確認（Slackアプリ設定で確認）
- ネットワーク接続を確認

**問題：送信済みフラグがTRUEのまま送信できない**
- 送信済みフラグをFALSEに変更すれば再送信可能

### 19.4 バックアップ

- スプレッドシートのバックアップはGoogleドライブが自動実行
- 重要なデータは定期的にエクスポートすることを推奨

## 21. 用語集

| 用語 | 説明 |
|------|------|
| GAS | Google Apps Scriptの略。GoogleスプレッドシートなどのGoogleサービスを自動化するスクリプト |
| Webhook | アプリケーション間でイベントを通知する仕組み。Slack Incoming Webhookは、HTTP POSTリクエストでメッセージを送信する |
| カレンダーID | Googleカレンダーを一意に識別するID。`primary`（プライマリカレンダー）または`xxx@group.calendar.google.com`形式 |
| 終日イベント | 開始時刻と終了時刻が設定されていない、1日全体のイベント |
| 送信済みフラグ | 日報がSlackに送信済みかどうかを示すフラグ（TRUE/FALSE） |
| MVP | Minimum Viable Product（最小実行可能製品）の略。最小限の機能で価値を提供する製品 |

## 22. 実装上の注意事項・ベストプラクティス

### 22.1 コーディング規約

- **変数名：** camelCaseを使用（例：`calendarId`, `kpiData`）
- **定数名：** UPPER_SNAKE_CASEを使用（例：`SHEET_NAME_KPI`, `COL_DATE`）
- **関数名：** camelCaseを使用（例：`getCalendarEvents`, `formatScheduleText`）
- **コメント：** 複雑なロジックには日本語コメントを追加
- **エラーハンドリング：** すべての外部API呼び出しにtry-catchを使用

### 22.2 データ整合性チェック

**日報生成時：**
- カレンダー予定取得の成功/失敗を確認
- KPIデータ取得の成功/失敗を確認
- データ書き込み前に既存行の存在を確認

**Slack送信時：**
- 送信済みフラグのチェック（必須）
- 該当日の行の存在確認（必須）
- 送信成功後にのみ送信済みフラグを更新

**データバリデーション：**
- 日付形式の検証（YYYY/MM/DD）
- 数値の範囲チェック（0以上の整数）
- 設定値の存在確認（Configシート）

### 22.3 エラーハンドリングのベストプラクティス

1. **早期リターン：** エラー検出時は即座に処理を中断
2. **トランザクション性：** 部分的成功を避ける（すべて成功 or すべて失敗）
3. **エラーメッセージ：** ユーザーに分かりやすい日本語で表示
4. **ログ記録：** 開発者向けの詳細情報をLogger.log()で記録
5. **データ保護：** エラー時はデータを更新しない

### 22.4 パフォーマンス最適化

- **必要最小限のデータ取得：** 該当日のデータのみ取得
- **API呼び出しの最小化：** キャッシュ可能なデータはキャッシュ（設定値等）
- **処理の早期中断：** エラー検出時は即座に中断
- **ログ出力の最適化：** 本番環境では不要なログを削減

### 22.5 セキュリティのベストプラクティス

- **機密情報の保護：** Webhook URLはConfigシートに保存（共有設定に注意）
- **権限の最小化：** 必要最小限の権限のみ要求
- **入力値の検証：** 外部からの入力（KPIシート等）は検証
- **エラーメッセージ：** 機密情報を含まない（システム内部情報を露出しない）

### 22.6 テスト容易性

- **関数の分離：** 単一責任の原則に従い、関数を小さく分割
- **依存性の注入：** 設定値はConfigシートから取得（ハードコードしない）
- **モックの利用：** 外部APIのモックを作成可能な構造
- **ログの活用：** デバッグ用のログを適切に配置

### 22.7 保守性の向上

- **コメントの適切な記述：** 複雑なロジックには説明を追加
- **定数の使用：** マジックナンバーや文字列リテラルは定数化
- **エラーメッセージの統一：** エラーコードとメッセージを定義
- **関数の再利用：** 共通処理は関数化

## 23. コードレビューチェックリスト

### 23.1 機能要件

- [ ] 日報生成機能が正しく実装されているか
- [ ] Slack送信機能が正しく実装されているか
- [ ] 二重送信防止が正しく実装されているか
- [ ] エラーハンドリングがすべてのケースで実装されているか

### 23.2 データ整合性

- [ ] 日付の重複チェックが実装されているか
- [ ] データのバリデーションが実装されているか
- [ ] 送信済みフラグのチェックが実装されているか
- [ ] データの上書き処理が正しく実装されているか

### 23.3 エラーハンドリング

- [ ] すべての外部API呼び出しにエラーハンドリングがあるか
- [ ] エラーメッセージがユーザーに分かりやすいか
- [ ] エラー時のデータ整合性が保たれているか
- [ ] ログが適切に記録されているか

### 23.4 コード品質

- [ ] 変数名・関数名が適切か（camelCase）
- [ ] 定数が適切に定義されているか（UPPER_SNAKE_CASE）
- [ ] コメントが適切に記述されているか
- [ ] コードの重複がないか
- [ ] 関数が適切に分割されているか（単一責任の原則）

### 23.5 パフォーマンス

- [ ] 不要なAPI呼び出しがないか
- [ ] データ取得が最小限になっているか
- [ ] 処理時間が要件を満たしているか

### 23.6 セキュリティ

- [ ] 機密情報が適切に保護されているか
- [ ] 入力値の検証が実装されているか
- [ ] エラーメッセージに機密情報が含まれていないか

## 24. デバッグ手順詳細

### 24.1 デバッグ環境の準備

1. Googleスプレッドシートを開く
2. 「拡張機能」>「Apps Script」でスクリプトエディタを開く
3. スクリプトを編集・保存

### 24.2 ログの確認方法

1. スクリプトエディタで「表示」>「ログ」を選択
2. 関数を実行（「実行」ボタンをクリック）
3. ログに出力された内容を確認

### 24.3 デバッグのポイント

**日報生成が失敗する場合：**
1. Logger.log()でConfigシートの設定値が正しく読み込めているか確認
2. Logger.log()でカレンダー予定が取得できているか確認
3. Logger.log()でKPIデータが取得できているか確認
4. Logger.log()でデータ書き込みが成功しているか確認

**Slack送信が失敗する場合：**
1. Logger.log()で送信済みフラグが正しくチェックされているか確認
2. Logger.log()でSlack投稿本文が正しく生成されているか確認
3. Logger.log()でWebhook URLが正しく取得できているか確認
4. HTTPレスポンスコードを確認（200 OK以外の場合はエラー）

**エラーメッセージが表示される場合：**
1. エラーメッセージの内容を確認
2. 該当する設定値やデータを確認
3. Logger.log()でエラー発生箇所を特定
4. エラー原因を解決

### 24.4 よくあるデバッグパターン

**パターン1：設定値が読み込めない**
- Configシートの設定項目名が正しいか確認（大文字小文字を区別）
- Configシートの設定値が空でないか確認

**パターン2：カレンダー予定が取得できない**
- カレンダーIDが正しいか確認
- カレンダーの共有設定を確認
- カレンダーに当日の予定が存在するか確認

**パターン3：KPIデータが取得できない**
- KPIシートに当日のデータが存在するか確認
- 日付の形式が正しいか確認（YYYY/MM/DD）
- 日付列（A列）が正しく設定されているか確認

**パターン4：Slack送信が失敗する**
- Webhook URLが有効か確認（Slackアプリ設定で確認）
- チャンネル名が正しいか確認（#から始まる）
- ネットワーク接続を確認

## 25. 障害対応手順

### 25.1 障害発生時の対応フロー

```
障害発生
  ↓
現象の確認
  ├─ エラーメッセージの確認
  ├─ ログの確認（Logger.log()）
  └─ データの状態確認
  ↓
原因の特定
  ├─ 設定値の確認（Configシート）
  ├─ データの確認（KPIシート、DailyReport_Draftシート）
  └─ 外部サービスの状態確認（Calendar、Slack）
  ↓
対応の実施
  ├─ 設定値の修正
  ├─ データの修正
  └─ スクリプトの修正（必要に応じて）
  ↓
動作確認
  ├─ テスト実行
  └─ ログの確認
  ↓
対応完了
```

### 25.2 障害パターン別対応手順

#### 障害パターン1：日報生成が失敗する

**症状：**
- 「日報生成」を実行するとエラーメッセージが表示される

**確認事項：**
1. Configシートの設定値が正しいか
2. カレンダーIDが有効か
3. KPIシートに当日のデータが存在するか
4. カレンダーの共有設定が正しいか

**対応手順：**
1. エラーメッセージの内容を確認
2. 該当する設定値やデータを修正
3. 再度「日報生成」を実行
4. 動作を確認

#### 障害パターン2：Slack送信が失敗する

**症状：**
- 「日報送信」を実行するとエラーメッセージが表示される
- Slackに投稿されない

**確認事項：**
1. 送信済みフラグがFALSEか
2. 該当日の日報が存在するか
3. Webhook URLが有効か
4. チャンネル名が正しいか
5. ネットワーク接続が正常か

**対応手順：**
1. エラーメッセージの内容を確認
2. 該当する設定値やデータを修正
3. 再度「日報送信」を実行
4. Slackで投稿を確認

#### 障害パターン3：データが正しく表示されない

**症状：**
- スケジュール本文が空
- KPI本文が空
- 日付が正しくない

**確認事項：**
1. カレンダーに当日の予定が存在するか
2. KPIシートに当日のデータが存在するか
3. 日付の形式が正しいか

**対応手順：**
1. 該当データを確認
2. データが存在しない場合は追加
3. データの形式を確認・修正
4. 再度「日報生成」を実行

### 25.3 緊急時の対応

**緊急時：**
- システムが使用できない状態が続く場合

**対応：**
1. 手動で日報を作成・送信（一時的な対応）
2. 原因を特定
3. 修正を実施
4. 動作確認後に通常運用に戻る

## 26. バージョン管理方針

### 26.1 バージョン番号の規則

- **形式：** v[メジャー].[マイナー].[パッチ]
- **例：** v1.0.0（初版）、v1.1.0（機能追加）、v1.0.1（バグ修正）

### 26.2 変更履歴の管理

- 仕様書の「改定履歴」セクションに記録
- 変更内容、変更日、変更者を記録

### 26.3 コードのバージョン管理

- GASスクリプトは「バージョン」機能を使用
- 重要な変更時はバージョンを保存
- 変更内容をコメントで記録

### 26.4 データのバージョン管理

- スプレッドシートの変更履歴は自動で記録される（Googleドライブの機能）
- 重要なデータ変更時は手動でバックアップを取得

## 27. 境界値テスト・ストレステスト

### 27.1 境界値テスト

#### テストケース：日付の境界値

| テストケース | 入力値 | 期待結果 |
|-------------|--------|----------|
| 最小値 | 2000/01/01 | 正常処理 |
| 最大値 | 2099/12/31 | 正常処理 |
| 無効な日付 | 2026/13/01 | エラー表示 |
| 無効な形式 | 2026-01-01 | エラー表示（YYYY/MM/DD形式のみ） |

#### テストケース：訪問数の境界値

| テストケース | 入力値 | 期待結果 |
|-------------|--------|----------|
| 最小値 | 0 | 正常処理 |
| 通常値 | 10 | 正常処理 |
| 最大値 | 9999 | 正常処理 |
| 負の値 | -1 | エラー表示 |
| 小数 | 1.5 | エラー表示（整数のみ） |
| 文字列 | "abc" | エラー表示 |

#### テストケース：カレンダー予定の件数

| テストケース | 予定件数 | 期待結果 |
|-------------|----------|----------|
| 0件 | 0 | 「・予定なし」と表示 |
| 1件 | 1 | 正常表示 |
| 通常値 | 10 | 正常表示 |
| 最大値 | 250 | 正常表示（API制限） |

### 27.2 ストレステスト

#### テストケース：大量データ処理

| テストケース | 条件 | 期待結果 |
|-------------|------|----------|
| 大量のカレンダー予定 | 250件の予定 | 処理時間5秒以内 |
| 大量のKPIデータ | 365日分のデータ | 該当日のデータのみ取得、処理時間1秒以内 |
| 大量の日報データ | 365日分の日報 | 該当日のデータのみ処理、処理時間1秒以内 |

#### テストケース：同時実行

| テストケース | 条件 | 期待結果 |
|-------------|------|----------|
| 複数ユーザーが同時に実行 | 2人以上のユーザーが同時実行 | データの整合性が保たれる（Googleスプレッドシートの機能） |

## 28. 参考資料

### 28.1 Google公式ドキュメント

- [Google Apps Script 公式ドキュメント](https://developers.google.com/apps-script)
- [Google Calendar API 公式ドキュメント](https://developers.google.com/calendar/api/v3/reference)
- [Slack Incoming Webhooks 公式ドキュメント](https://api.slack.com/messaging/webhooks)

### 28.2 関連ツール

- Googleスプレッドシート
- Googleカレンダー
- Slack

---

## 付録A：サンプルデータセット

### A.1 KPIシートのサンプルデータ（1ヶ月分）

| 日付 | 訪問数 | 架電数 | 商談数 |
|------|--------|--------|--------|
| 2026/01/01 | 0 | 0 | 0 |
| 2026/01/02 | 1 | 3 | 0 |
| 2026/01/03 | 2 | 5 | 1 |
| 2026/01/04 | 3 | 7 | 2 |
| 2026/01/05 | 2 | 4 | 1 |
| ... | ... | ... | ... |
| 2026/01/31 | 2 | 6 | 1 |

### A.2 DailyReport_Draftシートのサンプルデータ

| 日付 | スケジュール本文 | KPI本文 | 上手く行ったこと | 上手く行かなかったこと | 明日やること | 送信済み | 送信日時 |
|------|------------------|---------|------------------|------------------------|--------------|----------|----------|
| 2026/01/11 | 「・顧客訪問 10:00-11:00\n・会議 14:00-15:00」 | 「・訪問数：2件」 | 「新規顧客と商談が成立した」 | 「訪問先が不在だった」 | 「提案書を作成する」 | TRUE | 2026/01/11 18:30:00 |
| 2026/01/12 | 「・予定なし」 | 「・訪問数：3件」 | 「」 | 「」 | 「」 | FALSE | - |

### A.3 Configシートのサンプルデータ

| 設定項目 | 設定値 |
|----------|--------|
| CALENDAR_ID | primary |
| SLACK_WEBHOOK_URL | (YOUR_SLACK_WEBHOOK_URL) |
| SLACK_CHANNEL | #daily-report |

## 付録B：実装チェックリスト

### B.1 初期設定

- [ ] Googleスプレッドシートを作成
- [ ] KPIシートを作成し、列ヘッダーを設定
- [ ] DailyReport_Draftシートを作成し、列ヘッダーを設定
- [ ] Configシートを作成し、設定値を記入
- [ ] テスト用のKPIデータを入力

### B.2 GASスクリプト実装

- [ ] 定数定義（シート名、列インデックス、Config設定項目名）
- [ ] ユーティリティ関数（getTodayDateString, findRowByDate, showError）
- [ ] 設定読み込み関数（getConfigValue）
- [ ] カレンダー関連関数（getCalendarEvents, formatScheduleText）
- [ ] KPI関連関数（getKPIData, formatKPIText）
- [ ] Slack関連関数（formatDailyReportText, sendSlackMessage）
- [ ] メイン関数（generateDailyReport, sendToSlack）
- [ ] メニュー追加関数（onOpen）

### B.3 テスト

- [ ] 正常系テスト（すべてのテストケースを実行）
- [ ] 異常系テスト（すべてのテストケースを実行）
- [ ] 境界値テスト（すべてのテストケースを実行）
- [ ] エラーハンドリングテスト（すべてのエラーケースをテスト）

### B.4 ドキュメント

- [ ] コードにコメントを追加
- [ ] 使用方法の説明を追加
- [ ] 設定方法の説明を追加

## 付録C：トラブルシューティングFAQ

### C.1 よくある質問

**Q1：カレンダーIDの取得方法は？**
A1：Googleカレンダー設定画面 > カレンダーの統合 > カレンダーIDで確認できます。プライマリカレンダーの場合は「primary」を使用します。

**Q2：Slack Webhook URLの作成方法は？**
A2：Slackアプリ設定 > Incoming Webhooks > Webhook URLを追加で作成できます。

**Q3：送信済みフラグをFALSEに戻す方法は？**
A3：DailyReport_Draftシートの「送信済み」列（H列）の値をFALSEに変更します。

**Q4：過去日の日報を生成する方法は？**
A4：現在の仕様では過去日の日報は自動生成できません。手動で入力するか、スクリプトを修正する必要があります。

**Q5：複数のカレンダーから予定を取得する方法は？**
A5：現在の仕様では1つのカレンダーのみ対応しています。複数カレンダー対応は将来の拡張予定です。

**Q6：日報のフォーマットを変更する方法は？**
A6：`formatDailyReportText()`関数を修正します。

**Q7：エラーメッセージが表示されない場合の対処法は？**
A7：スクリプトエディタの「表示」>「ログ」でログを確認してください。

**Q8：処理が遅い場合の対処法は？**
A8：カレンダー予定の件数やKPIデータの量を確認してください。処理時間が6分を超える場合は、GASの実行時間制限に達している可能性があります。

---

**文書終了**
