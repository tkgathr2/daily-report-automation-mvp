# 簡単日報君 バグ一覧

## 実施情報

| 項目 | 値 |
|------|-----|
| 実施日 | 2026-02-22 |
| 対象ブランチ | master |
| コミットID | bafad7fbdcfe07a846c5914a20d139b5c9a44f86 |
| 本番URL | https://nippou.up.railway.app |

---

## バグサマリ

| バグID | テストケースID | 重要度 | タイトル |
|--------|---------------|--------|----------|
| BUG-001 | TC-010 | 中 | redirect-serviceにセキュリティヘッダーが未設定 |
| BUG-002 | TC-012 | 高 | redirect-serviceのリダイレクトURLにクエリパラメータがエスケープされずに付加される |
| BUG-003 | TC-093 | 中 | Code.gsのHTML出力でユーザー入力（メールアドレス）がエスケープされていない |

---

## BUG-001: redirect-serviceにセキュリティヘッダーが未設定

- **バグID**: BUG-001
- **テストケースID**: TC-010
- **重要度**: 中
- **分類**: セキュリティ

### 再現手順

1. `curl -I https://nippou.up.railway.app` を実行する
2. レスポンスヘッダーを確認する

### 期待結果

以下のセキュリティヘッダーがレスポンスに含まれること:
- `Content-Security-Policy`
- `X-XSS-Protection`
- `X-Frame-Options`
- `Strict-Transport-Security`

### 実結果

上記4つのセキュリティヘッダーが全て未設定。

レスポンスヘッダー（実測値）:
```
HTTP/2 200
content-type: text/html; charset=utf-8
server: railway-edge
x-railway-edge: railway/us-east4-eqdc4a
x-railway-request-id: yWRbabSASZSjlhV0PvyhXg
accept-ranges: bytes
date: Sun, 22 Feb 2026 00:38:34 GMT
via: 1.1 varnish
x-cache: MISS
x-cache-hits: 0
x-timer: S1771720714.984030,VS0,VE263
x-railway-cdn-edge: fastly/cache-bfi-krnt7300115-BFI
```

### 証拠

- テスト実行: 2026-02-22 00:38 UTC
- 実行方法: `curl -I https://nippou.up.railway.app`
- 該当コード: `redirect-service/index.js` L135-138（`res.writeHead(200, ...)`）

### 影響

- クリックジャッキング（X-Frame-Options未設定）
- XSS軽減策なし（CSP, X-XSS-Protection未設定）
- HSTS未設定（ただしRailwayがHTTPSを強制しているため実害は限定的）

### 原因

不明（セキュリティヘッダーが実装されていない）

---

## BUG-002: redirect-serviceのリダイレクトURLにクエリパラメータがエスケープされずに付加される

- **バグID**: BUG-002
- **テストケースID**: TC-012
- **重要度**: 高
- **分類**: セキュリティ（XSS/オープンリダイレクト）

### 再現手順

1. 以下のURLにアクセスする:
   ```
   https://nippou.up.railway.app/?param=<script>alert(1)</script>
   ```
2. リダイレクト先URLを確認する

### 期待結果

クエリパラメータがURLエンコードされ、`<script>` タグが無害化されたリダイレクトURLになること。

### 実結果

リダイレクト先URLに `<script>alert(1)</script>` がそのまま含まれる:
```
HTTP 302
Location: https://script.google.com/a/macros/takagi.bz/s/.../exec?from=nippou&param=<script>alert(1)</script>
```

### 証拠

- テスト実行: 2026-02-22 00:38 UTC
- 実行方法: `curl -s -o /dev/null -w "HTTP_CODE:%{http_code}\nREDIRECT_URL:%{redirect_url}\n" --max-redirs 0 "https://nippou.up.railway.app/?param=<script>alert(1)</script>"`
- 結果: `REDIRECT_URL:...exec?from=nippou&param=<script>alert(1)</script>`
- 該当コード: `redirect-service/index.js` L130
  ```javascript
  const redirectUrl = TARGET_URL + '?from=nippou' + separator.replace('?', '&') + queryString.replace('?', '');
  ```

### 影響

- redirect-service自体はHTMLを返さず302リダイレクトするため、redirect-service上では直接的なXSS発動はない
- リダイレクト先のGASがHTMLを返す場合、GAS側でクエリパラメータを反映するコードがあればXSSリスクがある
- 現時点ではGAS側のdoGet()はクエリパラメータをHTMLに直接埋め込まないため、即座の発動リスクは低い
- ただし、防御的プログラミングの観点からエスケープすべき

### 原因

不明（クエリパラメータのサニタイズ処理が実装されていない）

---

## BUG-003: Code.gsのHTML出力でユーザー入力（メールアドレス）がエスケープされていない

- **バグID**: BUG-003
- **テストケースID**: TC-093
- **重要度**: 中
- **分類**: セキュリティ（XSS）

### 再現手順

1. Code.gs L192のアクセス拒否ページ生成コードを確認:
   ```javascript
   const email = Session.getActiveUser().getEmail() || '不明';
   // ...
   <div class="email">${email}</div>
   ```
2. Code.gs L330-338の管理画面生成コードを確認:
   ```javascript
   <span class="info-value">${userInfo.email}</span>
   <span class="info-value">${userInfo.domain}</span>
   ```
3. emailの値にHTMLタグ（例: `<script>alert(1)</script>`）が含まれる場合、エスケープされずにHTMLに挿入される

### 期待結果

ユーザー入力（メールアドレス、ドメイン名）がHTMLエスケープされてから埋め込まれること。`<`, `>`, `"`, `'`, `&` などの特殊文字がエンティティに変換されること。

### 実結果

テンプレートリテラル `${}` でそのままHTMLに埋め込まれており、エスケープ処理が行われていない。

該当箇所:
- `src/Code.gs` L192: `<div class="email">${email}</div>` （アクセス拒否ページ）
- `src/Code.gs` L330: `<span class="info-value">${userInfo.email}</span>` （管理画面）
- `src/Code.gs` L334: `<span class="info-value">${userInfo.domain}</span>` （管理画面）
- `src/Code.gs` L338: `<span class="info-value">${userInfo.isAdmin ? '管理者' : '一般ユーザー'}</span>` （管理画面）

### 証拠

- テスト実行: 2026-02-22 00:40 UTC
- 実行方法: 静的コード検査（ソースコード読み取り）
- 該当コード: `src/Code.gs` L117-201（createAccessDeniedPage）, L207-383（createAdminPage）

### 影響

- 通常、GoogleのSession.getActiveUser().getEmail()はGoogleが管理するメールアドレスを返すため、`<script>` タグを含むメールアドレスが返される可能性は極めて低い
- しかし、防御的プログラミングの観点からエスケープすべき
- GAS HTMLサービスのセキュリティモデルにより、一部のスクリプト実行は制限される可能性がある

### 原因

不明（HTMLエスケープ関数が実装・適用されていない）

---

## 分類サマリ

### 重要度別

| 重要度 | 件数 | バグID |
|--------|------|--------|
| 高 | 1 | BUG-002 |
| 中 | 2 | BUG-001, BUG-003 |
| 低 | 0 | - |

### 分類別

| 分類 | 件数 | バグID |
|------|------|--------|
| セキュリティ（ヘッダー） | 1 | BUG-001 |
| セキュリティ（XSS/リダイレクト） | 1 | BUG-002 |
| セキュリティ（XSS） | 1 | BUG-003 |

### 止まりやすいポイント・白画面・モーダル不具合・OAuth不具合

| カテゴリ | 検出結果 |
|----------|----------|
| **停止（クラッシュ）** | 自動テスト範囲では検出なし。10,000文字クエリでもHTTP 414返却で安定。5並列リクエストでも正常応答。 |
| **白画面** | 自動テスト範囲（ログイン画面）では検出なし。HTML正常返却確認済み。ログイン後のメイン画面は手動テスト必要。 |
| **モーダル不具合** | ログイン前画面にはモーダルなし。ログイン後のチュートリアルモーダル・お知らせセクションは手動テスト必要。 |
| **OAuth不具合** | OAuthプロキシ（/oauth/callback）のリダイレクト動作は正常確認済み。code/state/errorパラメータの転送OK。実際のSlack OAuth認可フローは手動テスト必要。 |

### 再現率

| バグID | 再現率 | 備考 |
|--------|--------|------|
| BUG-001 | 100% | 全リクエストでセキュリティヘッダー不在 |
| BUG-002 | 100% | クエリパラメータ付きリクエストで常に再現 |
| BUG-003 | - | 静的検査による指摘。動作確認にはGoogleアカウントでのアクセスが必要 |

---

## 備考

- 本テストでは、Googleログインが必要なテスト（TC-019〜TC-022、TC-031〜TC-100の大部分）は認証情報なしのため実行不可
- 上記3件のバグは全てセキュリティ関連の指摘であり、機能的な停止・白画面・モーダル不具合は自動テスト範囲では検出されなかった
- ログイン後の機能テスト（日付選択、編集、Slack投稿、履歴、管理者画面）は手動テストでの確認が必要
- 原因推測は行わず、全て「不明」とした（証拠主義）
