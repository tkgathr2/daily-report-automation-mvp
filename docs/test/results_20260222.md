# 簡単日報君 E2Eテスト実施結果

## テスト実施情報

| 項目 | 値 |
|------|-----|
| 実施日 | 2026-02-22 |
| 対象ブランチ | master |
| コミットID | bafad7fbdcfe07a846c5914a20d139b5c9a44f86 |
| 本番URL | https://nippou.up.railway.app |
| GAS /exec URL | https://script.google.com/a/macros/takagi.bz/s/AKfycbyRu1Sye5cpmXqoqfGOI2BBReFh4cvqhkSr9CW7JS2XyhY7q32tv3A5gLG5rGwNtO5a4Q/exec |
| テスト環境 | Devin VM (Linux), Chrome (Playwright/Headless), curl |
| テスト実施者 | Devin AI (自動テスト) + 手動テスト手順整備 |

---

## 実施サマリ

| 区分 | 件数 |
|------|------|
| 自動テスト実行・PASS | 14 |
| 自動テスト実行・FAIL | 2 |
| 自動テスト実行・INFO（想定内の挙動） | 2 |
| 静的コード検査・指摘あり | 3 |
| 静的コード検査・問題なし | 1 |
| 手動テスト（手順のみ、実行不可） | 78 |
| **合計** | **100** |

---

## カテゴリ1: 起動/リダイレクト/アクセス制御（TC-001〜TC-015）

| ID | 実行方法 | 結果 | 備考 |
|----|----------|------|------|
| TC-001 | 自動(curl+ブラウザ) | **PASS** | HTTP 200。`簡単日報くん` タイトル、`Googleでログイン` ボタン、Google SVGアイコン、viewport meta、favicon link、`from=nippou` リンク、全て確認OK。 |
| TC-002 | 自動(curl) | **PASS** | HTTP 302。リダイレクト先: `GAS /exec?from=nippou&test=1`。クエリパラメータ正常転送確認。 |
| TC-003 | 自動(curl) | **INFO** | HTTP 302（Google認証画面へリダイレクト）。GASはWorkspaceドメイン制限のため、未認証curlでは直接のfrom=nippou判定まで到達しない。Googleログイン済みブラウザでの手動確認が必要。 |
| TC-004 | 手動テスト | **実行不可** | Googleログイン必要。手順: GAS /exec URL + `?from=nippou` にログイン済みブラウザでアクセス。 |
| TC-005 | 自動(curl) | **PASS** | HTTP 200。Content-Type: `image/svg+xml`。Cache-Control付き。 |
| TC-006 | 自動(curl) | **PASS** | HTTP 302。リダイレクト先: `GAS /exec?from=nippou`。不明パスは正しくGASへリダイレクト。 |
| TC-007 | 自動(curl) | **PASS** | HTTP 302。リダイレクト先: `GAS /exec`（クエリなし）。`from=nippou`なしでGASへ転送される。 |
| TC-008 | 自動(curl) | **PASS** | HTTP 302。リダイレクト先: `GAS /exec?code=fake&state=fake`。OAuthプロキシがクエリパラメータを正しく転送。 |
| TC-009 | 自動(curl) | **PASS** | HTTP 302。リダイレクト先: `GAS /exec?error=access_denied`。errorパラメータが正しく転送される。 |
| TC-010 | 自動(curl) | **FAIL** | HTTP 200。Content-Type正常。ただし**セキュリティヘッダー不足**: CSP, X-XSS-Protection, X-Frame-Options, HSTS が全て未設定。→ **BUG-001** |
| TC-011 | 自動(curl) | **PASS** | HTTP 414 (URI Too Long)。10,000文字のクエリでサーバークラッシュなし。Railway/Fastly CDNが適切にエラー返却。 |
| TC-012 | 自動(curl) | **FAIL** | HTTP 302。リダイレクト先URLに `<script>alert(1)</script>` がそのまま含まれる。redirect-serviceがクエリパラメータをエスケープせずにリダイレクトURLに付加。→ **BUG-002** |
| TC-013 | 自動(curl) | **PASS** | HTTP 200。HEADメソッド正常処理。 |
| TC-014 | 自動(curl) | **PASS** | HTTP 200。POSTメソッドでもログインページHTMLが返される（明示的な405ではないが、機能的に問題なし）。 |
| TC-015 | 自動(curl) | **PASS** | 5並列リクエスト全てHTTP 200。タイムアウトなし。 |

---

## カテゴリ2: ログイン/セッション/OAuth導線（TC-016〜TC-030）

| ID | 実行方法 | 結果 | 備考 |
|----|----------|------|------|
| TC-016 | 自動(ブラウザ) | **PASS** | `Googleでログイン` ボタンのhref属性が `GAS /exec?from=nippou` に正しく設定されていることを確認。 |
| TC-017 | 自動(curl+ブラウザ) | **PASS** | `<h1>簡単日報くん</h1>`、`Googleでログイン` テキスト、Google SVGアイコン（google-icon class）、ロゴSVG、全て存在確認。 |
| TC-018 | 自動(ブラウザ) | **PASS** | モバイルビューで表示確認。ログインカードが画面幅に収まり、ボタンサイズ適切。viewport meta設定あり（`width=device-width, initial-scale=1.0`）。 |
| TC-019 | 手動テスト | **実行不可** | takagi.bzドメインGoogleアカウントでのログイン確認。手順: ログイン画面→Googleでログイン→アカウント選択→権限許可→メイン画面表示確認。 |
| TC-020 | 手動テスト | **実行不可** | stepupnext.comドメインでのログイン確認。手順: TC-019と同様。 |
| TC-021 | 手動テスト | **実行不可** | kotsuyudo.comドメインでのログイン確認。手順: TC-019と同様。 |
| TC-022 | 手動テスト | **実行不可** | 非許可ドメイン（gmail.com等）でのアクセス拒否確認。手順: TC-019と同様の手順で非許可ドメインアカウントでログイン→「アクセス権限がありません」表示確認。 |
| TC-023 | 手動テスト | **実行不可** | ログイン済み状態でのSlack連携ボタン存在確認。メイン画面HTMLでSlack連携UI要素を確認。 |
| TC-024 | 手動テスト | **実行不可** | getSlackAuthorizeUrl()のURL生成確認。GASログから戻り値を確認。 |
| TC-025 | 手動テスト | **実行不可** | Slack OAuth完了後の「Slack連携が完了しました」メッセージ＋「アプリに戻る」リンク表示確認。 |
| TC-026 | 手動テスト | **実行不可** | state期限切れ（10分超過）時のエラーメッセージ確認。 |
| TC-027 | 手動テスト | **実行不可** | Slack認可拒否時の`?error=access_denied`処理確認。 |
| TC-028 | 自動(ブラウザ) | **PASS** | グラデーション背景（linear-gradient）、カード型レイアウト（border-radius: 20px、box-shadow）、フォント設定、全てCSS適用確認。 |
| TC-029 | 自動(ブラウザ) | **PASS** | ファビコン設定あり（`<link rel="icon" type="image/svg+xml" ...>`）。data:image/svg+xml形式でインラインSVG。 |
| TC-030 | 自動(ブラウザ) | **INFO** | ログイン画面で「Googleでログイン」クリック→Google認証画面（accounts.google.com）へ遷移確認。`@takagi.bz`ドメイン制限が表示される。ブラウザバック可能。 |

---

## カテゴリ3: 日付選択/予定取得/テンプレ反映（TC-031〜TC-045）

| ID | 実行方法 | 結果 | 備考 |
|----|----------|------|------|
| TC-031 | 手動テスト | **実行不可** | ログイン後メイン画面が正常にロードされるか確認。手順: ログイン→メイン画面でHTML要素（ヘッダー、テキストエリア、ボタン）の存在確認。 |
| TC-032 | 手動テスト | **実行不可** | 今日の日付が「YYYY年MM月DD日」形式で自動表示されるか確認。 |
| TC-033 | 手動テスト | **実行不可** | Googleアカウントの名前が自動取得・表示されるか確認。getUserName()がメール@前部分をフォーマットして返す。 |
| TC-034 | 手動テスト | **実行不可** | 予定がある日のカレンダー予定取得。getEventsForDate()の戻り値確認。 |
| TC-035 | 手動テスト | **実行不可** | 予定がない日のカレンダー予定取得。空文字列が返されるか確認。 |
| TC-036 | 手動テスト | **実行不可** | 日付ピッカーUIでの日付変更操作。選択した日付の予定が取得されるか。 |
| TC-037 | 手動テスト | **実行不可** | 過去の日付を選択した場合の予定取得。 |
| TC-038 | 手動テスト | **実行不可** | 未来の日付を選択した場合の予定取得。 |
| TC-039 | 手動テスト | **実行不可** | 終日イベントの表示形式確認（「終日 イベント名」形式）。 |
| TC-040 | 手動テスト | **実行不可** | 通常イベントの表示形式確認（「HH:mm-HH:mm イベント名」形式）。 |
| TC-041 | 手動テスト | **実行不可** | 4セクションテンプレートの表示確認（今日やったこと/わかった事/売上/次すること）。 |
| TC-042 | 手動テスト | **実行不可** | 「次すること」の翌日引き継ぎ確認。前日保存→翌日表示。 |
| TC-043 | 手動テスト | **実行不可** | 「次すること」の同日非表示確認。送信後、同日中は引き継ぎ表示されない。 |
| TC-044 | 手動テスト | **実行不可** | カレンダー予定取得中のローディング表示確認。 |
| TC-045 | 手動テスト | **実行不可** | カレンダーアクセスエラー時のエラーメッセージ確認。 |

---

## カテゴリ4: 編集/フォーマット/コピー/バリデーション（TC-046〜TC-060）

| ID | 実行方法 | 結果 | 備考 |
|----|----------|------|------|
| TC-046 | 手動テスト | **実行不可** | 「今日やったこと」セクションのテキスト編集可否確認。 |
| TC-047 | 手動テスト | **実行不可** | 「わかった事・問題・共有事項」セクションのテキスト編集可否確認。 |
| TC-048 | 手動テスト | **実行不可** | 「売上・利益・経費削減に関わるポイント」セクションのテキスト編集可否確認。 |
| TC-049 | 手動テスト | **実行不可** | 「次すること」セクションのテキスト編集可否確認。 |
| TC-050 | 手動テスト | **実行不可** | WYSIWYGツールバー：太字（Bold）ボタンの動作確認。 |
| TC-051 | 手動テスト | **実行不可** | WYSIWYGツールバー：斜体（Italic）ボタンの動作確認。 |
| TC-052 | 手動テスト | **実行不可** | WYSIWYGツールバー：下線（Underline）ボタンの動作確認。 |
| TC-053 | 手動テスト | **実行不可** | WYSIWYGツールバー：打ち消し線（Strikethrough）ボタンの動作確認。 |
| TC-054 | 手動テスト | **実行不可** | WYSIWYGツールバー：リンク挿入ボタンの動作確認。 |
| TC-055 | 手動テスト | **実行不可** | WYSIWYGツールバー：箇条書き（リスト）ボタンの動作確認。 |
| TC-056 | 手動テスト | **実行不可** | コピーボタンの動作確認。クリップボードにテキストがコピーされるか。 |
| TC-057 | 手動テスト | **実行不可** | バリデーション：全セクション空で投稿ボタン押下。エラーメッセージ表示確認。 |
| TC-058 | 手動テスト | **実行不可** | バリデーション：一部セクションのみ入力で投稿ボタン押下。 |
| TC-059 | 手動テスト | **実行不可** | バリデーション：空白文字のみの入力で投稿ボタン押下。 |
| TC-060 | 手動テスト | **実行不可** | 名前編集機能の動作確認（設定メニュー経由）。 |

---

## カテゴリ5: Slack投稿と投稿後画面（TC-061〜TC-070）

| ID | 実行方法 | 結果 | 備考 |
|----|----------|------|------|
| TC-061 | 手動テスト | **実行不可** | Slack連携済みで全セクション入力後の投稿成功確認。「送信成功：Slackに投稿しました。」メッセージ。 |
| TC-062 | 手動テスト | **実行不可** | 投稿成功時に「次すること」がUserPropertiesに保存されるか確認。 |
| TC-063 | 手動テスト | **実行不可** | Slack未連携状態での投稿ボタン押下。「Slack連携が必要です」エラー確認。 |
| TC-064 | 手動テスト | **実行不可** | Slackトークン期限切れ状態での投稿。「有効期限が切れています」エラー確認。 |
| TC-065 | 手動テスト | **実行不可** | Slack投稿メッセージの形式確認。ヘッダー+4セクション+Powered by簡単日報君。 |
| TC-066 | 手動テスト | **実行不可** | ユーザー名義での投稿確認（`as_user: true`）。Slackでユーザーアイコン・名前が表示されるか。 |
| TC-067 | 手動テスト | **実行不可** | 投稿後の画面状態確認。成功メッセージ表示後、フォームがどうなるか。 |
| TC-068 | 手動テスト | **実行不可** | 投稿ボタンの二重クリック防止確認。連打しても二重投稿にならないか。 |
| TC-069 | 手動テスト | **実行不可** | SLACK_CHANNEL_ID未設定時の投稿。「チャンネルが設定されていません」エラー確認。 |
| TC-070 | 手動テスト | **実行不可** | 非常に長いテキスト（各セクション1000文字以上）での投稿。 |

---

## カテゴリ6: 履歴サイドバー（TC-071〜TC-085）

| ID | 実行方法 | 結果 | 備考 |
|----|----------|------|------|
| TC-071 | 手動テスト | **実行不可** | 履歴サイドバーの表示確認。フローティングサイドバーが存在するか。 |
| TC-072 | 手動テスト | **実行不可** | サイドバーの開閉（トグル）操作確認。 |
| TC-073 | 手動テスト | **実行不可** | Slackタブでの履歴表示確認（search:readスコープ必要）。 |
| TC-074 | 手動テスト | **実行不可** | Gmailタブでの送信メール履歴表示確認。 |
| TC-075 | 手動テスト | **実行不可** | Notionタブでの更新ページ履歴表示確認。 |
| TC-076 | 手動テスト | **実行不可** | Slack連携済みでの履歴取得成功確認。 |
| TC-077 | 手動テスト | **実行不可** | Slack未連携での履歴取得エラー確認。「Slack未連携です」メッセージ。 |
| TC-078 | 静的検査 | **PASS** | ツール設定パネルの`display: none`確認。Code.gsのgetToolSettings()はデフォルトでslack:true, gmail:true, notion:trueを返す。Index.htmlでツール設定UIは非表示化されている。 |
| TC-079 | 手動テスト | **実行不可** | モバイル画面でのサイドバー表示確認。 |
| TC-080 | 手動テスト | **実行不可** | 履歴アイテムクリックで日報テキストエリアへの挿入確認。 |
| TC-081 | 手動テスト | **実行不可** | Slack履歴のチャンネル名表示確認（#channel名 or DM）。 |
| TC-082 | 手動テスト | **実行不可** | Gmail受信メール設定ON時の受信メール履歴表示確認。 |
| TC-083 | 手動テスト | **実行不可** | Notion未連携（トークン未設定）時のエラー確認。「Notion連携が設定されていません」メッセージ。 |
| TC-084 | 手動テスト | **実行不可** | 各ツール履歴が50件上限で取得されるか確認（MAX_ITEMS_PER_TOOL=50）。 |
| TC-085 | 手動テスト | **実行不可** | 全ツール一括取得（getAllToolHistoryV3）のエラーハンドリング確認。 |

---

## カテゴリ7: 管理者画面/ドメイン制御/権限/UI（TC-086〜TC-100）

| ID | 実行方法 | 結果 | 備考 |
|----|----------|------|------|
| TC-086 | 手動テスト | **実行不可** | takagi.bzドメイン（管理者）での管理画面アクセス確認。`?page=admin`パラメータ。 |
| TC-087 | 手動テスト | **実行不可** | stepupnext.comドメイン（非管理者）での管理画面アクセス拒否確認。 |
| TC-088 | 手動テスト | **実行不可** | 未ログイン状態での管理画面アクセス確認。 |
| TC-089 | 静的検査 | **PASS** | 管理画面HTMLにALLOWED_DOMAINS一覧が正しく表示されるコードを確認。`ALLOWED_DOMAINS.map()` でリスト生成。ADMIN_DOMAINSに含まれるドメインには「管理者」バッジ付与。 |
| TC-090 | 手動テスト | **実行不可** | 管理画面の「アプリに戻る」リンク確認。`getServiceUrl_()`が`https://nippou.up.railway.app`を返す。 |
| TC-091 | 静的検査 | **PASS** | 管理画面のシステム情報セクション確認。許可ドメイン数（3）と管理者ドメイン数（1）が表示されるコードを確認。 |
| TC-092 | 手動テスト | **実行不可** | 非管理者の管理画面アクセス拒否UI確認。「アクセス権限がありません」ページのデザイン確認。 |
| TC-093 | 静的検査 | **FAIL** | 管理画面・アクセス拒否ページのXSS検査。`${email}` と `${userInfo.email}` がHTMLテンプレートリテラルにエスケープなしで埋め込まれている。→ **BUG-003** |
| TC-094 | 手動テスト | **実行不可** | 管理画面URLの共有確認。`?page=admin`付きURLを直接共有した場合の挙動。 |
| TC-095 | 静的検査 | **PASS** | ドメインの大文字・小文字の取り扱い確認。`getUserDomain_()`で`toLowerCase()`を適用しており、ドメイン比較は大文字小文字を区別しない。 |
| TC-096 | 手動テスト | **実行不可** | チュートリアルモーダル（使い方ガイド）の表示確認。 |
| TC-097 | 手動テスト | **実行不可** | お知らせ（UPDATE）セクションの表示確認。最新20件が表示されるか。 |
| TC-098 | 手動テスト | **実行不可** | お知らせセクションの閉じる操作確認。 |
| TC-099 | 手動テスト | **実行不可** | 設定メニュー（名前編集）の表示・操作確認。 |
| TC-100 | 手動テスト | **実行不可** | レスポンシブデザイン確認（タブレット・モバイル表示）。メイン画面のレイアウト崩れがないか。 |

---

## 実行ログ（自動テスト詳細）

### redirect-service curlテスト（2026-02-22 00:38 UTC実行）

```
=== TC-001: Root access (no query) ===
HTTP_CODE:200
CONTENT_TYPE:text/html; charset=utf-8

Body checks:
  has_h1(簡単日報くん): PASS
  has_login_btn(Googleでログイン): PASS
  has_google_icon: PASS
  has_favicon: PASS
  has_target_url(from=nippou): PASS
  has_viewport: PASS
  has_title(簡単日報くん - ログイン): PASS

=== TC-002: Root with query params ===
HTTP_CODE:302
REDIRECT_URL:https://script.google.com/a/macros/takagi.bz/s/.../exec?from=nippou&test=1

=== TC-005: Favicon ===
HTTP_CODE:200
CONTENT_TYPE:image/svg+xml

=== TC-006: Unknown path (/nonexistent) ===
HTTP_CODE:302
REDIRECT_URL:https://script.google.com/a/macros/takagi.bz/s/.../exec?from=nippou

=== TC-007: OAuth callback (no params) ===
HTTP_CODE:302
REDIRECT_URL:https://script.google.com/a/macros/takagi.bz/s/.../exec

=== TC-008: OAuth callback (fake code+state) ===
HTTP_CODE:302
REDIRECT_URL:https://script.google.com/a/macros/takagi.bz/s/.../exec?code=fake&state=fake

=== TC-009: OAuth callback (error=access_denied) ===
HTTP_CODE:302
REDIRECT_URL:https://script.google.com/a/macros/takagi.bz/s/.../exec?error=access_denied

=== TC-010: HTTP Headers ===
HTTP/2 200
content-type: text/html; charset=utf-8
server: railway-edge
x-railway-edge: railway/us-east4-eqdc4a
(CSP: MISSING, X-XSS-Protection: MISSING, X-Frame-Options: MISSING, HSTS: MISSING)

=== TC-011: Large query param (10000 chars) ===
HTTP_CODE:414 (URI Too Long)

=== TC-012: XSS in query param ===
HTTP_CODE:302
REDIRECT_URL:...exec?from=nippou&param=<script>alert(1)</script>
(クエリパラメータがエスケープされずにリダイレクトURLに付加)

=== TC-013: HEAD method ===
HTTP_CODE:200

=== TC-014: POST method ===
HTTP_CODE:200

=== TC-015: Concurrent requests (5 parallel) ===
req1:HTTP_200, req2:HTTP_200, req3:HTTP_200, req4:HTTP_200, req5:HTTP_200
```

### ブラウザUIスモークテスト（2026-02-22 00:39 UTC実行）

```
=== デスクトップ表示 ===
URL: https://nippou.up.railway.app
結果: ログインカード正常表示
  - 「簡単日報くん」タイトル: 表示あり
  - 「ログインしてください」テキスト: 表示あり
  - 「Googleでログイン」ボタン: 表示あり、クリック可能
  - グラデーション背景: 適用済み
  - 白画面: なし
  - JSエラー: なし

=== モバイル表示 ===
URL: https://nippou.up.railway.app (viewport: 375x667相当)
結果: ログインカード正常表示
  - レイアウト崩れ: なし
  - ボタンサイズ: タップ可能
  - 画面はみ出し: なし

=== ログインボタンクリック ===
URL遷移: → accounts.google.com (Google認証画面)
  - @takagi.bz ドメイン制限が表示される
  - ブラウザバック可能
```

### 静的コード検査（2026-02-22 00:40 UTC実行）

```
=== redirect-service/index.js セキュリティヘッダー検査 ===
Content-Security-Policy: MISSING → BUG-001
X-XSS-Protection: MISSING → BUG-001
X-Frame-Options: MISSING → BUG-001
Strict-Transport-Security: MISSING → BUG-001

=== redirect-service/index.js リダイレクトURL構築 ===
LINE 130: クエリパラメータをエスケープせずにリダイレクトURLに付加
  const redirectUrl = TARGET_URL + '?from=nippou' + separator.replace('?', '&') + queryString.replace('?', '');
LINE 145: OAuthコールバックでもクエリパラメータをそのまま転送
  const redirectUrl = TARGET_URL + queryString;
→ BUG-002

=== Code.gs XSS検査 ===
LINE 192: ${email} がHTMLにエスケープなし埋め込み（アクセス拒否ページ）
LINE 330: ${userInfo.email} がHTMLにエスケープなし埋め込み（管理画面）
LINE 334: ${userInfo.domain} がHTMLにエスケープなし埋め込み（管理画面）
→ BUG-003

=== Code.gs ドメインチェック ===
getUserDomain_(): toLowerCase()適用あり → OK
ALLOWED_DOMAINS.includes(domain): 小文字化済みドメインとの比較 → OK

=== Code.gs OAuth State ===
verifySlackOAuthState_(): UUID生成 + 10分期限 → OK
```
