# Takagi Flow - 開発ワークフロー

## 概要

簡単日報くんプロジェクトにおけるフェーズ制、停止条件、チェックポイント方式、成功条件を定義する。

---

## 1. フェーズ制（Ask / Plan / Impl / Debug）

### 1.1 4フェーズの定義

| フェーズ | 名称 | 目的 | 成果物 |
|:--------:|------|------|--------|
| **Ask** | 要件定義 | 何を作るかを明確にする | 要件定義書（*_requirements_ASK.md） |
| **Plan** | 仕様書作成 | どう作るかを設計する | 仕様書（*_plan.md）、実装コード例 |
| **Impl** | 実装 | コードを書く | 実装済みコード、テスト |
| **Debug** | デバッグ・修正 | 品質を保証する | 動作確認済みシステム |

### 1.2 フェーズの進め方

```
Ask（60点→100点→100点）
  ↓
Plan（60点→100点→100点）
  ↓
Impl（実装・テスト）
  ↓
Debug（動作確認・修正）
  ↓
完了
```

**品質引き上げプロセス**:
- 初版60点版を作成
- レビュー → 100点版（1回目）に改善
- 最終レビュー → 最終100点版に改善

### 1.3 フェーズ未指定時の扱い

フェーズが明示されていない場合は **Askフェーズ** として扱う。
- 確認・質問・列挙のみ行う
- 実装は行わない

---

## 2. 停止条件

### 2.1 基本原則

不明点がある場合は、作業を停止してユーザーに確認する。

### 2.2 停止すべきケース

- SSOTに記載がない動作を判断する必要がある場合
- 既存仕様と矛盾する指示を受けた場合
- 実装方法に複数の選択肢があり、どちらを選ぶべきか不明な場合
- 参照すべきドキュメントに該当情報が存在しない場合

### 2.3 停止時の行動

1. 作業を中断する
2. 不明点を明確に列挙する
3. ユーザーの判断を待つ（勝手に判断しない）

---

## 3. チェックポイント方式

### 3.1 チェックポイント一覧（CP-01〜CP-08）

#### CP-01: スプレッドシートの初期設定

- [ ] 新しいGoogleスプレッドシートを作成
- [ ] シート①「KPI」を作成し、列ヘッダーを設定（日付、訪問数、架電数、商談数）
- [ ] シート②「DailyReport_Draft」を作成し、列ヘッダーを設定
- [ ] シート③「Config」を作成し、設定項目と設定値を記入
- [ ] テスト用のKPIデータを1行以上入力

#### CP-02: GASスクリプトの基本構造作成

- [ ] スプレッドシートにGASスクリプトエディタを開く
- [ ] メイン関数 `generateDailyReport()` を作成
- [ ] 設定読み込み関数 `getConfigValue(key)` を作成
- [ ] カスタムメニューを追加する関数 `onOpen()` を作成
- [ ] スクリプトを保存・実行権限を付与

#### CP-03: カレンダー連携実装

- [ ] `getCalendarEvents(date)` 関数を作成
- [ ] Calendar APIを使用して当日の予定を取得
- [ ] `formatScheduleText(events)` 関数でテキストフォーマット
- [ ] テスト：カレンダー予定が正しく取得できることを確認

#### CP-04: KPIシート連携実装

- [ ] `getKPIData(date)` 関数を作成
- [ ] KPIシートから該当日の行を検索
- [ ] データが存在しない場合のエラーハンドリング
- [ ] `formatKPIText(kpiData)` 関数でテキストフォーマット
- [ ] テスト：KPIデータが正しく取得できることを確認

#### CP-05: 日報下書き生成実装

- [ ] `generateDailyReport()` のメインロジックを実装
- [ ] DailyReport_Draftシートにデータを書き込み
- [ ] 同日の行が存在する場合は上書き処理
- [ ] テスト：日報下書きが正しく生成されることを確認

#### CP-06: Slack送信機能実装

- [ ] `formatDailyReportText(rowData)` 関数を作成
- [ ] `sendToSlack(date)` 関数を作成
- [ ] Webhook URLを使用してSlackに投稿
- [ ] 送信成功時に送信済みフラグと送信日時を更新
- [ ] 送信済みフラグチェックを実装
- [ ] テスト：Slack送信が正常に動作することを確認

#### CP-07: エラーハンドリング実装

- [ ] カレンダー関連エラーの処理
- [ ] KPIシート関連エラーの処理
- [ ] Slack送信関連エラーの処理
- [ ] Config設定関連エラーの処理
- [ ] すべてのエラーケースをテスト

#### CP-08: 統合テスト

- [ ] 正常系テスト（すべてのテスト項目を実行）
- [ ] 異常系テスト（すべてのテスト項目を実行）
- [ ] 受け入れ条件をチェック
- [ ] NG例が発生しないことを確認

---

## 4. 成功条件（結果ベース）

成功は「動作結果」で判定する。プロセスではなく結果のみを基準とする。

### 4.1 MVP/V1 成功条件

| No | 条件 | 判定方法 |
|----|------|----------|
| 1 | GAS WEBアプリとしてデプロイでき、ブラウザからアクセスできる | 画面表示確認 |
| 2 | プライマリカレンダーから当日の予定を取得できる | ボタン操作で確認 |
| 3 | 予定が0件でもエラーにならない | 予定なし日にテスト |
| 4 | 終日イベントが「（終日）」形式で表示される | 画面確認 |
| 5 | 予定が開始時刻の昇順で表示される | 画面確認 |
| 6 | テキストエリアで編集でき、編集内容が反映される | 画面操作で確認 |
| 7 | 「コピー」ボタンでクリップボードにコピーされる | 貼り付けで確認 |
| 8 | Slackに正しいフォーマットで送信される | Slack画面で確認 |
| 9 | エラー時に日本語のエラーメッセージが表示される | エラー条件で確認 |
| 10 | Webhook URL未設定時にエラーメッセージが表示される | 設定なしでテスト |

### 4.2 V2 成功条件

| No | 条件 | 判定方法 |
|----|------|----------|
| 1 | 新テンプレート（4セクション構成）で日報が表示される | 画面確認 |
| 2 | ヘッダーに日付と氏名が自動で入る | 画面確認 |
| 3 | 日付形式が「YYYY年MM月DD日」になっている | 画面確認 |
| 4 | 氏名がGoogleアカウントから自動取得される | 画面確認 |
| 5 | セクション空欄時にエラーメッセージが表示される | 送信操作で確認 |
| 6 | 全セクション入力ありで送信可能 | 送信操作で確認 |
| 7 | 「次すること」が翌日に自動表示される | 翌日アクセスで確認 |
| 8 | 引き継ぎ内容が編集・削除可能 | 画面操作で確認 |
| 9 | 既存機能（カレンダー取得、コピー、Slack送信）が正常動作 | 既存テストで確認 |
| 10 | Slack投稿が新テンプレート形式で送信される | Slack画面で確認 |

---

## 5. バージョン別開発ロードマップ

### 5.1 実装順序

```
V2 → V3 → V4 → V5 → V6 → V7
```

各バージョンは前のバージョンが完成していることが前提。

### 5.2 バージョン一覧

| バージョン | 機能カテゴリ | 詳細 | 必要な外部設定 |
|:----------:|--------------|------|----------------|
| **V2** | テンプレート変更＋入力欄追加＋翌日引き継ぎ | 4セクション構成、氏名自動取得、必須バリデーション、「次すること」引き継ぎ | なし |
| **V3** | ツール連携①（Slack/Gmail/Notion） | 各ツールの履歴を自動取得して「今日やったこと」に表示 | Slack追加スコープ、Notion Token |
| **V4** | ツール連携②（Docs/Drive/Dropbox） | ファイル操作履歴を自動取得 | Dropbox Token |
| **V5** | ツール連携③（Zoom/Meet/社内ツール） | 会議参加履歴を自動取得 | Zoom Token、社内ツールエンドポイント |
| **V6** | AIによる自動処理 | 重要度順並べ替え、最大10件絞り込み、削除・編集UI | OpenAI API Key |
| **V7** | 個人最適化 | ツールON/OFF設定、よく使う順の自動学習 | なし |

### 5.3 関連ドキュメント

| 種別 | パス |
|------|------|
| 要件定義書（Ask） | `docs/specs/V2〜V7_requirements_ASK.md` |
| 仕様書（Plan） | `docs/specs/V2〜V7_plan.md` |
| Devinタスクファイル | `docs/devin_tasks/V2〜V7.md` |

---

## 6. 運用ルール

### 6.1 Single Source of Truth（SSOT）

判断の根拠は以下の3ファイルのみ:

1. `docs/takagi_flow.md`（このファイル）
2. `docs/claude_code_rules.md`
3. `docs/requirements.md`

### 6.2 1機能 = 1PR

- 1つの機能追加は1つのPRで完結させる
- PRは小さく保つ
- 複数機能の同時実装を避ける

### 6.3 変更対象ファイル

| ファイル | 説明 |
|----------|------|
| `src/Code.gs` | バックエンド（GAS） |
| `src/Index.html` | フロントエンド（HTML/CSS/JS） |

### 6.4 シークレット管理

API KeyやTokenはScript Propertiesに保存する。コードに直接書かない。

---

以上
