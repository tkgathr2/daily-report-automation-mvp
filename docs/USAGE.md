# 簡単日報くん 使用方法・デプロイ手順書

## 目次

1. [概要](#概要)
2. [初期設定](#初期設定)
3. [デプロイ手順](#デプロイ手順)
4. [使用方法](#使用方法)
5. [トラブルシューティング](#トラブルシューティング)

## 概要

「簡単日報くん」は、Googleカレンダーから今日の予定を取得し、WEBブラウザ上で表示・編集・コピー → Slack送信できるWEBアプリです。

### 機能

- Googleカレンダーから今日の予定を自動取得
- WEBブラウザ上で予定データを編集
- クリップボードにコピー
- Slackチャンネルに投稿（OAuth認証で自分のアカウントとして投稿）

## 初期設定

### 1. GASプロジェクトの準備

1. [Google Apps Script](https://script.google.com/) にアクセス
2. 「新しいプロジェクト」をクリック
3. プロジェクト名を「簡単日報くん」に変更（任意）

### 2. コードファイルの作成

1. `Code.gs` ファイルに `src/Code.gs` の内容をコピー&ペースト
2. 「ファイル」→「新規」→「HTMLファイル」を選択
3. ファイル名を `Index` に設定
4. `Index.html` ファイルに `src/Index.html` の内容をコピー&ペースト

### 3. Slack Appの作成（OAuth設定）

1. [Slack API](https://api.slack.com/apps) にアクセス
2. 「Create New App」→「From scratch」をクリック
3. App名（例：「簡単日報くん」）とワークスペースを選択して作成
4. 左メニューの「OAuth & Permissions」をクリック
5. 「Redirect URLs」セクションで「Add New Redirect URL」をクリック
   - GASのWEBアプリURL（デプロイ後に取得）を追加
6. 「User Token Scopes」セクションで以下のスコープを追加：
   - `chat:write`
7. 左メニューの「Basic Information」に戻り、以下をメモ：
   - **Client ID**
   - **Client Secret**

### 4. スクリプトプロパティの設定

1. GASエディタで「プロジェクトの設定」（歯車アイコン）をクリック
2. 「スクリプト プロパティ」セクションまでスクロール
3. 以下のプロパティを追加：

| プロパティ名 | 値 |
|-------------|-----|
| `SLACK_CLIENT_ID` | Slack AppのClient ID |
| `SLACK_CLIENT_SECRET` | Slack AppのClient Secret |
| `SLACK_CHANNEL_ID` | 投稿先チャンネルのID（例：`C01234ABCDE`） |

**チャンネルIDの取得方法：**
- Slackでチャンネルを右クリック →「チャンネル詳細を表示」→ 最下部の「チャンネルID」をコピー

## デプロイ手順

### 1. WEBアプリとしてデプロイ

1. GASエディタで「デプロイ」→「新しいデプロイ」をクリック
2. 種類の選択で「ウェブアプリ」を選択
3. 設定を入力：
   - **説明**：任意（例：「簡単日報くん v2.0」）
   - **次のユーザーとして実行**：自分
   - **アクセスできるユーザー**：全員（または自分のみ）
4. 「デプロイ」をクリック
5. **初回デプロイ時のみ**：
   - 「承認が必要です」ダイアログが表示される
   - 「許可を確認」をクリック
   - Googleアカウントを選択
   - 「詳細」→「（安全ではないページ）に移動」をクリック（警告が表示される場合）
   - 「許可」をクリックして権限を付与
6. デプロイが完了したら、WEBアプリのURLをコピー

### 2. Slack AppにRedirect URLを追加

1. [Slack API](https://api.slack.com/apps) で作成したAppを開く
2. 「OAuth & Permissions」→「Redirect URLs」
3. デプロイしたWEBアプリのURLを追加して保存

**重要：Google Workspaceドメインを使用している場合**

Google Workspaceドメイン（例：takagi.bz）でGASを使用している場合、2種類のURL形式が存在します。**両方のURLをRedirect URLsに登録する必要があります**：

1. `/a/macros/ドメイン/s/デプロイID/exec`（デプロイ管理画面に表示される形式）
2. `/a/ドメイン/macros/s/デプロイID/exec`（実行時に生成される形式）

例：
- `https://script.google.com/a/macros/example.com/s/AKfycbw.../exec`
- `https://script.google.com/a/example.com/macros/s/AKfycbw.../exec`

OAuth認証時にエラーが発生した場合は、エラーメッセージに表示されるURLをそのままRedirect URLsに追加してください。

### 3. デプロイ後の確認

1. コピーしたURLにブラウザでアクセス
2. 「簡単日報くん」の画面が表示されることを確認
3. 初回アクセス時、Googleアカウントへのアクセス許可を求められる場合は「許可」をクリック

## 使用方法

### 基本的な使い方

#### 1. 今日の予定を取得

1. WEBアプリのURLにアクセス
2. 「今日の予定を取得」ボタンをクリック
3. テキストエリアに今日のカレンダー予定が表示されます

**表示形式：**
```
・予定タイトル 10:00-11:00
・終日イベント（終日）
・別の予定 14:00-15:00
```

#### 2. 予定データの編集

1. テキストエリアの内容を直接編集できます
2. 追加・削除・変更が可能です
3. 改行も自由に追加できます

#### 3. コピー

1. 「コピー」ボタンをクリック
2. テキストエリアの内容がクリップボードにコピーされます
3. 他のアプリケーション（メール、ドキュメント等）に貼り付け可能です

#### 4. Slack連携（初回のみ）

1. 「Slack連携（認可）」ボタンをクリック
2. Slackの認可画面が表示されます
3. 「許可する」をクリックしてアプリを承認
4. 自動的にアプリに戻り、「Slack連携済みです。」と表示されます

#### 5. Slackに投稿

1. Slack連携が完了していることを確認
2. 「Slackに投稿」ボタンをクリック
3. 送信成功時に「送信成功：Slackに投稿しました。」と表示されます
4. 設定したSlackチャンネルで投稿を確認できます

**Slack投稿形式：**
```
【日報】2026/01/11

■ 本日のスケジュール
・予定タイトル 10:00-11:00
・別の予定 14:00-15:00
```

## トラブルシューティング

### 問題：カレンダー予定が取得できない

**原因と対処法：**

1. **カレンダーへのアクセス権限がない**
   - WEBアプリにアクセスした際の権限確認ダイアログで「許可」をクリック
   - GASエディタで「表示」→「ログ」を確認してエラー内容を確認

2. **プライマリカレンダーに予定が存在しない**
   - 今日の日付に予定が存在することを確認
   - 別のカレンダーではなく、プライマリカレンダーに予定があることを確認

### 問題：Slack連携ができない

**原因と対処法：**

1. **Client ID/Secretが設定されていない**
   - GASエディタで「プロジェクトの設定」→「スクリプト プロパティ」を確認
   - `SLACK_CLIENT_ID` と `SLACK_CLIENT_SECRET` が正しく設定されているか確認
   - エラーメッセージ：「エラー：Slack連携URLを生成できません。管理者に連絡してください。」

2. **Redirect URLが設定されていない**
   - Slack AppのOAuth設定でRedirect URLにWEBアプリのURLが追加されているか確認

3. **認可がタイムアウトした**
   - 「Slack連携（認可）」から10分以上経過すると無効になります
   - 再度「Slack連携（認可）」ボタンをクリックしてやり直してください

### 問題：Slack送信が失敗する

**原因と対処法：**

1. **Slack連携が完了していない**
   - 「Slack連携（認可）」ボタンをクリックして連携を完了してください
   - エラーメッセージ：「エラー：Slack連携が必要です。「Slack連携（認可）」を実行してください。」

2. **チャンネルIDが設定されていない**
   - スクリプトプロパティに `SLACK_CHANNEL_ID` が設定されているか確認
   - エラーメッセージ：「エラー：Slackチャンネル設定がありません。管理者に連絡してください。」

3. **チャンネルに参加していない**
   - 投稿先のSlackチャンネルに参加してから再度お試しください
   - エラーメッセージ：「エラー：チャンネルに参加していないため投稿できません。」

4. **トークンが無効になった**
   - 再度「Slack連携（認可）」を実行してください
   - エラーメッセージ：「エラー：Slack連携が無効になりました。再度「Slack連携（認可）」を実行してください。」

### 問題：コピー機能が動作しない

**原因と対処法：**

- モダンブラウザ（Chrome、Firefox、Safari、Edge等）を使用しているか確認
- ブラウザの権限設定でクリップボードへのアクセスが許可されているか確認
- フォールバック機能により、テキストエリアを選択してコピーする方法も使用できます

### その他の問題

- **予期しないエラーが発生する**
  - GASエディタで「表示」→「ログ」を確認
  - エラーメッセージの内容を確認
  - ブラウザの開発者ツール（F12）でJavaScriptエラーを確認

## 補足情報

### 対応ブラウザ

- Google Chrome（推奨）
- Firefox
- Safari
- Microsoft Edge

### 権限について

このアプリは以下の権限が必要です：

- **Googleカレンダーへのアクセス**：今日の予定を取得するため
- **Slack OAuth**：ユーザーとしてSlackに投稿するため

### 制限事項

- プライマリカレンダーのみ対応（他のカレンダーは対象外）
- 実行当日の予定のみ取得可能
- Slack送信は1回ずつ手動実行
- 投稿先チャンネルはスクリプトプロパティで固定

### サポート

問題が解決しない場合は、GASエディタの「表示」→「ログ」でエラー内容を確認してください。
