# V3 要件定義書（Ask）

## ドキュメント情報

| 項目 | 内容 |
|------|------|
| 文書名 | 簡単日報くん V3 要件定義書 |
| バージョン | 3.0（最終100点版） |
| 作成日 | 2026-01-24 |
| 最終更新日 | 2026-01-24 |
| フェーズ | Ask（要件定義）完了 |
| ステータス | 最終100点版 → Plan移行可 |
| 前提バージョン | V2（テンプレート変更＋入力欄追加＋翌日引き継ぎ） |

---

## 1. 目的・背景

### 1.1 目的

V2で追加した「今日やったこと」欄に、**Slack・Gmail・Notionの利用履歴を自動取得**して表示し、
日報作成の手間をさらに削減する。

### 1.2 背景

- V2では「今日やったこと」はカレンダー予定のみ
- 実際の業務ではSlack、メール、Notionでの作業も多い
- これらのツールから履歴を自動取得すれば「書く」から「確認して送る」に変わる

### 1.3 期待される効果

- 日報作成時間のさらなる短縮
- 作業の事実が自動で記録される
- 抜け漏れの防止

---

## 2. 対象機能一覧

| No | 機能ID | 機能名 | 概要 | 難易度 |
|----|--------|--------|------|:------:|
| 1 | A1 | Slack履歴の自動取得 | Slackでの投稿・やりとりを自動で集める | 高 |
| 2 | A2 | Gmail履歴の自動取得 | 送受信したメールを自動で集める | 高 |
| 3 | A6 | Notion履歴の自動取得 | Notion操作を自動で集める | 高 |

---

## 3. 機能詳細

### 3.1 Slack履歴の自動取得（A1）

#### 概要
ユーザーが当日Slackで行った投稿・リアクションを取得し、「今日やったこと」に表示する。

#### 取得対象
- 自分が投稿したメッセージ（当日分）
- 自分がリアクションしたメッセージ（当日分）

#### 取得しない対象
- 他人の投稿（自分が関与していないもの）
- DMの内容（プライバシー保護）
- 削除されたメッセージ

#### 表示形式
```
⚫︎ [Slack] #general: 「会議の件、了解しました」
⚫︎ [Slack] #project-a: ファイル共有
```

#### 認証方式
- 既存のSlack OAuth連携を拡張
- 追加スコープ: `search:read`（メッセージ検索用）

---

### 3.2 Gmail履歴の自動取得（A2）

#### 概要
ユーザーが当日送受信したメールを取得し、「今日やったこと」に表示する。

#### 取得対象
- 自分が送信したメール（当日分）
- 自分が受信したメール（当日分、任意でON/OFF）

#### 取得しない対象
- スパムフォルダのメール
- ゴミ箱のメール
- 自動生成メール（通知系）

#### 表示形式
```
⚫︎ [Gmail] 送信: 「〇〇様 見積書送付の件」
⚫︎ [Gmail] 受信: 「△△株式会社より お問い合わせの件」
```

#### 認証方式
- GASのGmail API（CalendarApp同様に自動認証）
- GmailApp.search() を使用

---

### 3.3 Notion履歴の自動取得（A6）

#### 概要
ユーザーが当日Notionで編集したページを取得し、「今日やったこと」に表示する。

#### 取得対象
- 自分が編集したページ（当日分）
- 自分が作成したページ（当日分）

#### 取得しない対象
- 他人が編集したページ
- 削除されたページ

#### 表示形式
```
⚫︎ [Notion] 編集: 「プロジェクトA 議事録」
⚫︎ [Notion] 作成: 「週次レポート 1/24」
```

#### 認証方式
- Notion API（Integration Token）
- OAuth 2.0 または Internal Integration

---

## 4. 前提条件

| No | 前提条件 | 確認方法 |
|----|----------|----------|
| 1 | V2が完成・稼働している | 動作確認済み |
| 2 | Slack OAuthが連携済み（既存） | V1/V2で対応済み |
| 3 | Googleアカウントでログイン済み（Gmail用） | GASで自動 |
| 4 | Notion Integration Tokenが設定可能 | 管理者設定 |

---

## 5. 受け入れ条件

| No | 受け入れ条件 | 確認方法 |
|----|--------------|----------|
| 1 | Slack履歴が「今日やったこと」に自動表示される | 画面確認 |
| 2 | Gmail履歴が「今日やったこと」に自動表示される | 画面確認 |
| 3 | Notion履歴が「今日やったこと」に自動表示される | 画面確認 |
| 4 | 各ツールの取得ON/OFFが設定できる | 設定画面確認 |
| 5 | カレンダー予定と各ツール履歴がまとめて表示される | 画面確認 |
| 6 | 表示順は時系列（または設定で変更可能） | 画面確認 |
| 7 | 既存機能（V2）が正常に動作する | 既存テスト |

---

## 6. NG例

| No | NG例 | 理由 |
|----|------|------|
| 1 | DMの内容が取得される | プライバシー侵害 |
| 2 | 他人のメッセージ/メールが取得される | 対象外 |
| 3 | 認証エラーでアプリ全体が動かなくなる | 影響範囲が大きすぎる |
| 4 | 取得に時間がかかりすぎる（30秒以上） | UX悪化 |
| 5 | 既存のV2機能が動かなくなる | 後方互換性 |

---

## 7. 例外ケース

| No | 例外ケース | 発生条件 | 対応方針 | エラーメッセージ |
|----|------------|----------|----------|------------------|
| 1 | Slack追加スコープ未認可 | ユーザーが拒否 | Slack履歴のみ取得しない（他は動作） | 「Slack履歴の取得には追加の権限が必要です。」 |
| 2 | Gmail API エラー | API制限、権限不足 | Gmail履歴のみ取得しない | 「Gmail履歴を取得できませんでした。」 |
| 3 | Notion Token未設定 | 管理者未設定 | Notion履歴のみ取得しない | 「Notion連携が設定されていません。」 |
| 4 | Notion API エラー | API制限、権限不足 | Notion履歴のみ取得しない | 「Notion履歴を取得できませんでした。」 |
| 5 | 取得データが大量 | 1日に100件以上 | 最新20件に絞る | なし（自動で絞り込み） |

---

## 8. 非機能要件

| No | カテゴリ | 要件 | 基準値 |
|----|----------|------|--------|
| 1 | パフォーマンス | 全ツール取得合計時間 | 15秒以内 |
| 2 | パフォーマンス | 各ツール個別取得時間 | 5秒以内 |
| 3 | 可用性 | 1ツール失敗時 | 他ツールは正常動作 |
| 4 | セキュリティ | トークン保存 | Script Properties（暗号化推奨） |
| 5 | セキュリティ | DMコンテンツ | 取得しない |
| 6 | 互換性 | V2機能 | 全て維持 |

---

## 9. データ要件

### 9.1 取得データ

| ツール | データ | 取得元 |
|--------|--------|--------|
| Slack | 投稿メッセージ、リアクション | Slack API（search.messages） |
| Gmail | 送受信メール件名 | GmailApp.search() |
| Notion | 編集/作成ページタイトル | Notion API（search） |

### 9.2 保存が必要なデータ

| データ | 保存先 | 目的 |
|--------|--------|------|
| Notion Integration Token | Script Properties | API認証 |
| ツール取得ON/OFF設定 | User Properties | 個人設定 |

---

## 10. 依存関係

| 依存先 | 内容 | 影響 |
|--------|------|------|
| V2 | テンプレート、「今日やったこと」欄 | V2が前提 |
| Slack OAuth | 既存連携を拡張 | スコープ追加が必要 |
| Gmail API | GASネイティブ | 追加設定不要 |
| Notion API | 外部API | Integration Token設定必要 |

---

## 11. 今回やらないこと（Won't）

| No | やらないこと | 理由 |
|----|--------------|------|
| 1 | Googleドキュメント/Drive連携 | V4で対応 |
| 2 | Dropbox連携 | V4で対応 |
| 3 | Zoom/Google Meet連携 | V5で対応 |
| 4 | AIによる重要度並べ替え | V6で対応 |
| 5 | ツールごとの詳細設定（取得件数等） | 複雑化を避ける |

---

## 12. テスト観点

### 12.1 正常系テスト

| No | テスト項目 | 確認内容 |
|----|------------|----------|
| 1 | Slack履歴取得 | 当日の投稿が表示される |
| 2 | Gmail履歴取得 | 当日の送受信メールが表示される |
| 3 | Notion履歴取得 | 当日の編集ページが表示される |
| 4 | 複合表示 | カレンダー＋各ツール履歴がまとめて表示 |
| 5 | ON/OFF設定 | 設定に応じて表示が変わる |

### 12.2 異常系テスト

| No | テスト項目 | 確認内容 |
|----|------------|----------|
| 1 | Slack権限不足 | エラーメッセージ、他は正常動作 |
| 2 | Gmail API失敗 | エラーメッセージ、他は正常動作 |
| 3 | Notion Token未設定 | エラーメッセージ、他は正常動作 |
| 4 | 大量データ | 20件に絞られる |

---

## 13. 用語定義

| 用語 | 定義 |
|------|------|
| Integration Token | Notion APIにアクセスするためのトークン |
| スコープ | OAuth認証で許可される権限の範囲 |
| search:read | Slackのメッセージ検索権限 |

---

## 14. 注意事項（実装者向け）

1. **Slack追加スコープ**: 既存のOAuth連携に`search:read`スコープを追加する必要がある。再認可フローが必要になる可能性あり。

2. **Gmail**: GASのGmailAppはCalendarApp同様に自動認証されるが、初回実行時に権限承認ダイアログが表示される。

3. **Notion**: Internal Integration Tokenを使う場合、管理者がNotion側でIntegrationを作成し、対象ページに明示的にアクセス権を付与する必要がある。

4. **エラーハンドリング**: 各ツールの取得は独立して行い、1つが失敗しても他に影響しないようにする。

---

## 改定履歴

| バージョン | 日付 | 内容 |
|------------|------|------|
| 1.0 | 2026-01-24 | 60点版 初版作成 |
| 2.0 | 2026-01-24 | 100点版（1回目） |
| 3.0 | 2026-01-24 | 最終100点版：注意事項追加、エラーハンドリング方針明確化 |
